================================================
DATEI: app.py
================================================
import os
from functools import lru_cache
from typing import Any, Dict, Optional

import yt_dlp  # WICHTIG: pip install yt-dlp
from flask import (
    Blueprint,
    Flask,
    jsonify,
    redirect,
    render_template,
    request,
    send_from_directory,
    session,
)
from pydantic import BaseModel, EmailStr, ValidationError
from werkzeug.exceptions import BadRequest, HTTPException
from werkzeug.utils import secure_filename
from dotenv import load_dotenv

# Load environment variables
load_dotenv()

# Internal Modules
from config import SNIPPET_DIR, STATIC_DIR, UPLOAD_DIR
import database
from job_manager import manager as job_manager
from services.processor import resolve_audio_stream_url
from backend.storage import load_json_value
from backend.models import (
    QueueSubmission,
    ResolveAudioRequest,
    ResolveMetadataRequest,
    SetMetadataRequest,
    SetRenameRequest,
    ToggleFavoriteRequest,
    PurchaseToggleRequest,
    TrackFlagRequest,
    FolderAssignRequest,
    FolderCreateRequest
)
from services.user_store import (
    DEFAULT_ADMIN_EMAIL,
    UserStore,
    LoginPayload,
    RegisterPayload,
    ProfileUpdatePayload,
    InvitePayload
)

# Initialize Database
database.init_db()

app = Flask(__name__)
app.secret_key = os.environ.get("FLASK_SECRET_KEY", "dev-secret-key")

# Blueprints
auth_api = Blueprint("auth_api", __name__, url_prefix="/api/auth")

# Initialize User Store & Create Admin
user_store = UserStore()
ADMIN_LOGIN_EMAIL = user_store.ensure_default_admin().email

# --- Helper Functions ---

def get_current_user():
    """Retrieves the current user object based on the session ID."""
    if "user_id" not in session:
        return None
    return user_store.get_by_id(session["user_id"])

@app.context_processor
def inject_user():
    """Makes the 'current_user' variable available in all Jinja templates."""
    return dict(current_user=get_current_user())

@lru_cache(maxsize=500)
def cached_resolve_audio(query):
    return resolve_audio_stream_url(query)

def parse_body(model_cls):
    """Parses JSON body against a Pydantic model."""
    data = request.get_json(silent=True)
    if data is None:
        raise BadRequest("Request body must be JSON")
    try:
        return model_cls.model_validate(data)
    except ValidationError as exc:
        raise BadRequest(exc.errors())


def parse_profile_payload() -> ProfileUpdatePayload:
    """Parses profile update payload from JSON or multipart form data."""
    content_type = request.content_type or ""

    if "multipart/form-data" in content_type:
        avatar_url: Optional[str] = None
        avatar_file = request.files.get("avatar")
        if avatar_file and avatar_file.filename:
            filename = secure_filename(avatar_file.filename)
            avatar_dir = os.path.join(STATIC_DIR, "avatars")
            os.makedirs(avatar_dir, exist_ok=True)
            save_path = safe_path(avatar_dir, filename)
            avatar_file.save(save_path)
            avatar_url = f"/static/avatars/{filename}"

        form_data: Dict[str, Optional[str]] = {
            "name": request.form.get("display_name") or request.form.get("name"),
            "dj_name": request.form.get("dj_name"),
            "soundcloud_url": request.form.get("soundcloud_url"),
        }

        if avatar_url is not None:
            form_data["avatar_url"] = avatar_url

        normalized: Dict[str, Optional[str]] = {}
        for key, value in form_data.items():
            if value is None:
                continue
            if isinstance(value, str):
                value = value.strip()
                if value == "":
                    continue
            normalized[key] = value
        try:
            return ProfileUpdatePayload.model_validate(normalized)
        except ValidationError as exc:
            raise BadRequest(exc.errors())

    return parse_body(ProfileUpdatePayload)

def safe_path(base: str, *paths: str) -> str:
    """Prevents directory traversal attacks."""
    base_abs = os.path.abspath(base)
    candidate = os.path.abspath(os.path.join(base_abs, *paths))
    if not candidate.startswith(base_abs + os.sep) and candidate != base_abs:
        raise BadRequest("Invalid path")
    return candidate

def set_session(user):
    """Sets session variables after login."""
    session["user_id"] = user.id
    session["email"] = user.email
    session["is_admin"] = user.is_admin

def require_session_user():
    """Middleware-like helper for API protection."""
    user = get_current_user()
    if not user:
        return None, (jsonify({"ok": False, "error": "Not authorized"}), 401)
    return user, None


# --- Frontend Routes ---

@app.route("/")
def index():
    user = get_current_user()
    if not user:
        return redirect("/login")
    return render_template("index.html", user=user)

@app.route("/login")
def login_page():
    if "user_id" in session:
        return redirect("/")
    return render_template("login.html")

@app.route("/register")
def register_page():
    if "user_id" in session:
        return redirect("/")
    return render_template("register.html")

@app.route("/profile")
def profile_page():
    user = get_current_user()
    if not user:
        session.clear()
        return redirect("/login")

    user_collections = database.get_all_sets()
    liked_tracks = database.get_liked_tracks()
    stats = database.get_dashboard_stats()

    display_name = user.name or user.dj_name or user.email

    return render_template(
        "profile.html",
        username=display_name,
        user=user,
        collections=user_collections,
        liked_tracks=liked_tracks,
        stats=stats,
    )


# --- API: Auth ---

@auth_api.route("/register", methods=["POST"])
def register_api():
    payload = parse_body(RegisterPayload)
    try:
        user = user_store.add_user(payload.email, payload.password, name=payload.name)
    except ValueError as exc:
        return jsonify({"ok": False, "error": str(exc)}), 409

    set_session(user)
    return jsonify({"ok": True, "user": user.model_dump()})

@auth_api.route("/login", methods=["POST"])
def login():
    data: Dict[str, Any] = {}
    json_data = request.get_json(silent=True)
    if isinstance(json_data, dict):
        data.update(json_data)

    for key in ("email", "password"):
        if key not in data and key in request.form:
            data[key] = request.form.get(key)

    raw_email = str(data.get("email") or "").strip()
    password = str(data.get("password") or "").strip()

    class _AdminEmailModel(BaseModel):
        email: EmailStr

    try:
        admin_email = _AdminEmailModel(email=os.getenv("ADMIN_EMAIL", ADMIN_LOGIN_EMAIL)).email
    except ValidationError:
        admin_email = ADMIN_LOGIN_EMAIL

    admin_aliases = [admin_email, DEFAULT_ADMIN_EMAIL]
    admin_aliases = [email for email in admin_aliases if email]
    admin_alias_set = {email.lower() for email in admin_aliases}

    normalized_email = raw_email.lower()
    candidate_emails = []

    if normalized_email == "admin" or normalized_email in admin_alias_set:
        candidate_emails.extend(admin_aliases)
    else:
        candidate_emails.append(raw_email)

    validated_emails = []
    for email in candidate_emails:
        try:
            validated_emails.append(LoginPayload(email=email, password=password).email)
        except ValidationError:
            continue

    if not validated_emails:
        return jsonify({"ok": False, "error": "Invalid credentials"}), 401

    user = None
    for email in validated_emails:
        user = user_store.authenticate(email, password)
        if user:
            break

    if not user:
        return jsonify({"ok": False, "error": "Invalid credentials"}), 401

    set_session(user)
    role = "admin" if user.is_admin else "user"
    return jsonify({"ok": True, "user": user.model_dump(), "role": role})

@auth_api.route("/profile", methods=["GET", "POST"])
def profile():
    user, error_response = require_session_user()
    if error_response:
        return error_response
        
    if request.method == "POST":
        payload = parse_profile_payload()
        updated_user = user_store.update_user(user.id, payload.model_dump(exclude_unset=True))
        if updated_user:
            body = {"ok": True, "user": updated_user.model_dump()}
            if updated_user.avatar_url:
                body["avatar_url"] = updated_user.avatar_url
            return jsonify(body)
        return jsonify({"ok": False, "error": "Update failed"}), 500
        
    return jsonify({"ok": True, "user": user.model_dump()})

@auth_api.route("/logout", methods=["POST"])
def logout():
    session.clear()
    return jsonify({"ok": True})


# Register blueprints
app.register_blueprint(auth_api)


# --- API: Sets & Tracks ---

@app.route("/api/sets")
def list_sets():
    return jsonify(database.get_all_sets())

@app.route("/api/sets/<int:sid>/tracks")
def list_tracks(sid):
    return jsonify(database.get_tracks_by_set_with_relations(sid))

@app.route("/api/sets/<int:sid>/rename", methods=["POST"])
def rename_set(sid):
    payload = parse_body(SetRenameRequest)
    database.rename_set(sid, payload.name)
    return jsonify({"ok": True})

@app.route("/api/sets/<int:sid>/metadata", methods=["POST"])
def update_set_metadata(sid):
    payload = parse_body(SetMetadataRequest)
    database.update_set_metadata(sid, payload.model_dump(exclude_none=True))
    return jsonify({"ok": True})

@app.route("/api/sets/<int:sid>", methods=["DELETE"])
def delete_set(sid):
    deleted = database.delete_set(sid)
    return jsonify({"ok": bool(deleted), "deleted": deleted})

@app.route("/api/tracks/<int:tid>", methods=["DELETE"])
def delete_track(tid):
    deleted = database.delete_track(tid)
    status = 200 if deleted else 404
    return jsonify({"ok": bool(deleted), "deleted": deleted}), status

@app.route("/api/tracks/<int:tid>/like", methods=["POST"])
def like_track(tid):
    data = parse_body(ToggleFavoriteRequest)
    liked = 1 if data.liked else 0
    database.toggle_track_like(tid, liked)
    return jsonify({"ok": True})

@app.route("/api/tracks/likes")
def get_liked_tracks_endpoint():
    return jsonify(database.get_liked_tracks())

@app.route("/api/tracks/<int:tid>/purchase", methods=["POST"])
def purchase_track(tid):
    data = parse_body(PurchaseToggleRequest)
    purchased = 1 if data.purchased else 0
    database.toggle_track_purchase(tid, purchased)
    return jsonify({"ok": True})

@app.route("/api/tracks/purchases")
def purchased_tracks():
    return jsonify(database.get_purchased_tracks())

@app.route("/api/folders", methods=["GET", "POST"])
def folders():
    if request.method == "GET":
        return jsonify({"folders": database.get_folders_with_sets()})

    payload = parse_body(FolderCreateRequest)
    folder = database.create_folder(payload.name)
    return jsonify({"ok": True, "folder": folder})

@app.route("/api/folders/<int:folder_id>/sets", methods=["POST", "DELETE"])
def assign_folder(folder_id: int):
    payload = parse_body(FolderAssignRequest)
    if request.method == "DELETE":
        database.remove_set_from_folder(folder_id, payload.set_id)
    else:
        database.assign_set_to_folder(folder_id, payload.set_id)
    return jsonify({"ok": True, "folders": database.get_folders_with_sets()})

@app.route("/api/producers/<int:pid>/like", methods=["POST"])
def like_producer(pid):
    data = parse_body(ToggleFavoriteRequest)
    liked = 1 if data.liked else 0
    database.toggle_producer_like(pid, liked)
    return jsonify({"ok": True})

@app.route("/api/producers/likes")
def liked_producers():
    return jsonify(database.get_favorite_producers())

@app.route("/api/tracks/<int:tid>/flag", methods=["POST"])
def flag_track(tid):
    data = parse_body(TrackFlagRequest)
    flag = int(data.flag or 0)
    database.update_track_flag(tid, flag)
    return jsonify({"ok": True})


# --- API: Metadata Resolver ---

@app.route("/api/resolve_metadata", methods=["POST"])
def get_metadata():
    """Fetches metadata via yt-dlp quickly."""
    data = parse_body(ResolveMetadataRequest)
    url = data.url

    ydl_opts = {
        'quiet': True,
        'no_warnings': True,
        'extract_flat': True,
        'skip_download': True
    }

    with yt_dlp.YoutubeDL(ydl_opts) as ydl:
        try:
            info = ydl.extract_info(url, download=False)
        except Exception as e:
             return jsonify({"ok": False, "error": str(e)}), 400

        title = info.get('title', '')
        uploader = info.get('uploader', '')

        artist_guess = uploader
        name_guess = title
        event_guess = ""

        if " - " in title:
            parts = title.split(" - ", 1)
            if len(parts) == 2:
                if uploader and uploader.lower() in ["h√∂r berlin", "boiler room", "mixmag", "cercle"]:
                    event_guess = uploader
                    artist_guess = parts[0]
                    name_guess = parts[1]
                else:
                    artist_guess = parts[0]
                    name_guess = parts[1]

        return jsonify({
            "ok": True,
            "name": name_guess.strip(),
            "artist": artist_guess.strip(),
            "event": event_guess.strip()
        })


# --- API: Queue & Jobs ---

@app.route("/api/queue/add", methods=["POST"])
def add_job():
    metadata: Dict[str, Any] = {}
    submission_type = None
    submission_value = None

    if request.is_json:
        data = request.get_json(force=True)
        submission_type = data.get("type")
        submission_value = data.get("value")
        metadata = data.get("metadata") or {}
    else:
        metadata_raw = request.form.get("metadata")
        if metadata_raw:
            try:
                metadata = load_json_value(metadata_raw) or {}
            except Exception as exc:
                raise BadRequest(f"Invalid metadata payload: {exc}")

        submission_type = request.form.get("type")
        submission_value = request.form.get("value")

    if submission_type == "url":
        if not submission_value:
            raise BadRequest("URL missing")
        job_manager.add_job("url", submission_value, metadata)

    elif submission_type == "file":
        if request.is_json:
            raise BadRequest("File upload requires multipart form data")
        if 'file' not in request.files:
            raise BadRequest("File upload required")
        file = request.files['file']
        if not file or not file.filename:
            raise BadRequest("File upload required")
        
        filename = secure_filename(file.filename)
        os.makedirs(UPLOAD_DIR, exist_ok=True)
        save_path = safe_path(UPLOAD_DIR, filename)
        file.save(save_path)
        job_manager.add_job("file", save_path, metadata)
    
    else:
        raise BadRequest("Invalid job type")

    return jsonify({"ok": True})

@app.route("/api/queue/status")
def queue_status():
    return jsonify(job_manager.get_status())

@app.route("/api/queue/stop", methods=["POST"])
def queue_stop():
    stopped = job_manager.stop_active()
    return jsonify({"ok": True, "stopped": stopped})


# --- API: Rescan & Audio ---

@app.route("/api/tracks/rescan_candidates")
def rescan_list():
    return jsonify(database.get_rescan_candidates())

@app.route("/api/tracks/rescan_run", methods=["POST"])
def rescan_run():
    database.reset_rescan_flags()
    return jsonify({"ok": True, "processed": 1})

@app.route("/api/resolve_audio", methods=["POST"])
def resolve_audio():
    data = parse_body(ResolveAudioRequest)
    query = data.query
    url = cached_resolve_audio(query)
    if url:
        return jsonify({"ok": True, "url": url})
    return jsonify({"ok": False}), 404

@app.route("/api/dashboard")
def dashboard_stats():
    return jsonify(database.get_dashboard_stats())

@app.route("/api/youtube/feeds")
def youtube_feeds():
    artists = request.args.get("artists")
    query = request.args.get("q")

    if artists:
        artist_list = [a.strip() for a in artists.split(",") if a.strip()]
    else:
        artist_list = database.get_engaged_artists(query=query)

    if not artist_list:
        return jsonify({"ok": False, "error": "No artists found from likes/purchases"}), 404

    feeds = database.fetch_youtube_feed(artist_list)
    return jsonify({"ok": True, "items": feeds, "artists": artist_list})

@app.route("/api/sets/import", methods=["POST"])
def run_import():
    import services.importer as importer
    n = importer.import_json_files()
    return jsonify({"ok": True, "imported": n})


# --- Static Files ---

@app.route("/snippets/<path:filename>")
def serve_snippets(filename):
    return send_from_directory(SNIPPET_DIR, filename)

@app.route("/static/<path:filename>")
def serve_static(filename):
    return send_from_directory(STATIC_DIR, filename)

@app.route("/static/js/<path:filename>")
def serve_js(filename):
    return send_from_directory(os.path.join(STATIC_DIR, "js"), filename)


# --- Error Handling ---

@app.errorhandler(Exception)
def handle_exception(error):
    if isinstance(error, ValidationError):
        code = 400
        message = error.errors()
    elif isinstance(error, HTTPException):
        code = error.code or 500
        message = getattr(error, "description", str(error))
    else:
        code = 500
        message = str(error) or "Internal Server Error"

    return jsonify({"error": True, "message": message, "code": code}), code


if __name__ == "__main__":
    print("Starte Tracklistify Helper auf http://127.0.0.1:5000")
    app.run(host="0.0.0.0", port=5000, debug=True)


================================================
DATEI: templates/index.html
================================================
<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tracklistify Studio</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #05070c;
            --bg-glow: radial-gradient(circle at 20% 20%, rgba(255, 107, 0, 0.16), transparent 30%),
                        radial-gradient(circle at 80% 0%, rgba(76, 151, 255, 0.1), transparent 28%),
                        radial-gradient(circle at 50% 90%, rgba(255, 255, 255, 0.04), transparent 30%);
            --panel: rgba(15, 19, 28, 0.7);
            --glass: rgba(255, 255, 255, 0.04);
            --border: rgba(255, 255, 255, 0.08);
            --muted: #9ca3af;
            --text: #f3f4f6;
            --accent: #ff6b00;
            --accent-strong: #ff7f22;
            --success: #16a34a;
            --radius: 16px;
            --shadow: 0 24px 80px rgba(0, 0, 0, 0.55);
            --signal: #ff6b00;
            --surface-strong: rgba(255, 255, 255, 0.06);
            --surface-muted: rgba(255, 255, 255, 0.02);
            --card-height: 320px;
            --card-gap: 16px;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            min-height: 100vh;
            font-family: 'Inter', 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg);
            background-image: var(--bg-glow);
            color: var(--text);
            letter-spacing: 0.02em;
        }

        h1, h2, h3, h4, h5, h6 { margin: 0; font-weight: 800; letter-spacing: 0.08em; text-transform: uppercase; }
        p { margin: 0; }
        a { color: inherit; text-decoration: none; }
        button { font-family: inherit; cursor: pointer; }
        [x-cloak] { display: none !important; }
        .muted { color: var(--muted); }
        .accent-hover { transition: all 0.2s ease; }
        .accent-hover:hover { border-color: var(--accent); background: var(--glass); }
        .contrast-active { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(255, 107, 0, 0.2); }

        .app-shell {
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 20px;
            padding: 24px;
            min-height: 100vh;
        }

        .glass-panel {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            backdrop-filter: blur(18px);
            box-shadow: var(--shadow);
        }

        .library {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .library-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 18px 20px;
            border-bottom: 1px solid var(--border);
        }

        .brand {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .brand .eyebrow {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.18em;
            color: var(--muted);
        }

        .brand .title {
            font-size: 18px;
            font-weight: 800;
            letter-spacing: 0.14em;
        }

        .icon-button {
            width: 40px;
            height: 40px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            border: 1px solid var(--border);
            background: var(--glass);
            color: var(--text);
            transition: all 0.2s ease;
        }

        .icon-button:hover {
            border-color: var(--accent);
            color: var(--accent);
            transform: translateY(-1px);
        }

        .library-search {
            padding: 0 20px;
            display: grid;
            gap: 10px;
        }

        .input {
            width: 100%;
            border: 1px solid var(--border);
            background: rgba(255, 255, 255, 0.04);
            color: var(--text);
            padding: 12px 14px;
            border-radius: 12px;
            font-weight: 600;
            letter-spacing: 0.08em;
        }

        .input:focus {
            outline: 1px solid var(--accent);
            border-color: var(--accent);
        }

        .hint {
            font-size: 11px;
            color: var(--muted);
            letter-spacing: 0.08em;
            text-transform: uppercase;
        }

        .folder-list {
            display: grid;
            gap: 10px;
            padding: 0 20px 10px;
        }

        .folder {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 14px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: rgba(255, 255, 255, 0.02);
            transition: all 0.2s ease;
        }

        .folder.is-hovered, .folder-drop-target {
            border-color: var(--accent);
            background: rgba(255, 107, 0, 0.08);
            box-shadow: 0 0 0 2px rgba(255, 107, 0, 0.15);
        }

        .folder-quiet {
            background: rgba(255, 255, 255, 0.02);
        }

        .folder.is-hovered {
            border-color: var(--accent);
            background: rgba(255, 107, 0, 0.08);
        }

        .folder .meta {
            display: grid;
            gap: 4px;
        }

        .folder .name {
            font-weight: 700;
            letter-spacing: 0.06em;
        }

        .folder .count {
            font-size: 11px;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .trash-zone {
            margin: 10px 20px 20px;
            padding: 14px;
            border: 1px dashed var(--border);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            color: var(--muted);
            letter-spacing: 0.1em;
            text-transform: uppercase;
            background: rgba(255, 255, 255, 0.02);
            transition: all 0.2s ease;
        }

        .trash-zone.is-hovered {
            border-color: var(--accent);
            color: var(--accent);
            background: rgba(255, 107, 0, 0.08);
        }

        .main {
            display: flex;
            flex-direction: column;
            gap: 18px;
        }

        .top-nav {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
        }

        .logo-mark {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-ring {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            background: linear-gradient(135deg, rgba(255, 107, 0, 0.18), rgba(76, 151, 255, 0.18));
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border: 1px solid var(--border);
        }

        .logo-text {
            display: grid;
            line-height: 1.1;
        }

        .logo-text span:first-child {
            font-size: 12px;
            letter-spacing: 0.14em;
            color: var(--muted);
        }

        .logo-text span:last-child {
            font-size: 15px;
            font-weight: 800;
            letter-spacing: 0.2em;
        }

        .nav-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .pill {
            padding: 10px 14px;
            border-radius: 999px;
            border: 1px solid var(--border);
            background: rgba(255, 255, 255, 0.04);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-size: 11px;
            font-weight: 700;
            color: var(--text);
        }

        .pill-link {
            border-color: transparent;
            color: var(--muted);
            transition: color 0.2s ease;
        }

        .pill-link:hover { color: var(--accent); }

        .cta {
            background: linear-gradient(135deg, var(--accent), var(--accent-strong));
            border: none;
            color: #0c0b0b;
            font-weight: 800;
            padding: 12px 18px;
            border-radius: 12px;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            box-shadow: 0 16px 40px rgba(255, 107, 0, 0.32);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .cta:hover { transform: translateY(-1px); box-shadow: 0 22px 48px rgba(255, 107, 0, 0.42); }
        .cta:active { transform: translateY(0); }

        .user-chip {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: rgba(255, 255, 255, 0.03);
        }

        .avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, rgba(255, 107, 0, 0.24), rgba(76, 151, 255, 0.24));
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            letter-spacing: 0.08em;
        }

        .stat-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 12px;
            padding: 12px 16px 16px;
        }

        .stat {
            padding: 16px;
            border-radius: 14px;
            border: 1px solid var(--border);
            background: rgba(255, 255, 255, 0.04);
            backdrop-filter: blur(12px);
            display: grid;
            gap: 6px;
        }

        .stat .label {
            font-size: 11px;
            letter-spacing: 0.14em;
            color: var(--muted);
        }

        .stat .value {
            font-size: 26px;
            font-weight: 800;
            letter-spacing: 0.06em;
        }

        .content {
            padding: 0 16px 16px;
            display: grid;
            gap: 18px;
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            padding: 0 4px;
        }

        .section-header h2 {
            font-size: 14px;
        }

        .set-grid {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: var(--card-gap);
        }

        .set-card {
            position: relative;
            overflow: hidden;
            border-radius: 14px;
            border: 1px solid var(--border);
            background: linear-gradient(160deg, rgba(255, 255, 255, 0.06), rgba(15, 19, 28, 0.7));
            display: flex;
            flex-direction: column;
            height: var(--card-height);
            cursor: pointer;
            transition: transform 0.2s ease, border-color 0.2s ease, background 0.2s ease;
        }

        .set-card:hover {
            transform: translateY(-2px);
            border-color: var(--accent);
            background: linear-gradient(160deg, rgba(255, 255, 255, 0.08), rgba(15, 19, 28, 0.9));
        }

        .set-card.is-dragging {
            opacity: 0.35;
            filter: contrast(0.85);
            transform: scale(0.985);
            border-color: var(--border);
        }

        .set-card.is-drop-target {
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(255, 107, 0, 0.3);
            filter: contrast(1.05);
        }

        .set-thumb {
            background-size: cover;
            background-position: center;
            position: relative;
            height: 160px;
        }

        .set-thumb::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(180deg, transparent 20%, rgba(0, 0, 0, 0.55));
        }

        .set-thumb .fallback {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            letter-spacing: 0.18em;
            color: rgba(255, 255, 255, 0.7);
            background: linear-gradient(135deg, rgba(255, 107, 0, 0.22), rgba(76, 151, 255, 0.22));
        }

        .set-meta {
            padding: 14px 16px 16px;
            display: grid;
            gap: 8px;
            flex: 1;
        }

        .set-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            border-radius: 999px;
            background: rgba(255, 255, 255, 0.08);
            font-size: 11px;
            letter-spacing: 0.12em;
        }

        .set-title {
            font-size: 16px;
            font-weight: 800;
            letter-spacing: 0.06em;
        }

        .set-artist {
            font-size: 12px;
            color: var(--muted);
            letter-spacing: 0.08em;
        }

        .set-progress {
            width: 100%;
            height: 6px;
            background: rgba(255, 107, 0, 0.12);
            border-radius: 999px;
            overflow: hidden;
            position: relative;
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.08);
        }

        .set-progress span {
            display: block;
            height: 100%;
            background: linear-gradient(90deg, var(--signal), var(--accent-strong));
            box-shadow: 0 8px 18px rgba(255, 107, 0, 0.32);
            transition: width 0.25s ease;
        }

        .set-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px 16px;
            font-size: 12px;
            color: var(--muted);
            letter-spacing: 0.08em;
        }

        .set-footer .tag {
            padding: 6px 10px;
            border-radius: 10px;
            background: var(--surface-muted);
            border: 1px solid var(--border);
            color: var(--text);
            letter-spacing: 0.08em;
            font-weight: 700;
            font-size: 11px;
        }

        .track-panel {
            padding: 16px;
            border-radius: 14px;
            border: 1px solid var(--border);
            background: rgba(255, 255, 255, 0.03);
        }

        .track-panel.focused {
            border-color: rgba(255, 107, 0, 0.4);
            box-shadow: 0 16px 40px rgba(255, 107, 0, 0.15);
        }

        .track-panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .track-panel-header .title {
            display: grid;
            gap: 4px;
        }

        .track-panel-header .title span:first-child {
            font-size: 12px;
            letter-spacing: 0.14em;
            color: var(--muted);
        }

        .track-panel-header .title span:last-child {
            font-size: 16px;
            font-weight: 800;
            letter-spacing: 0.08em;
        }

        .action-link {
            padding: 10px 12px;
            border-radius: 10px;
            border: 1px solid var(--border);
            letter-spacing: 0.1em;
            text-transform: uppercase;
            font-size: 11px;
            background: rgba(255, 255, 255, 0.04);
        }

        .tracklist {
            display: grid;
            gap: 10px;
        }

        .track {
            display: grid;
            grid-template-columns: 60px 1fr 140px 90px 100px;
            align-items: center;
            gap: 10px;
            padding: 12px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid var(--border);
        }

        .track:hover { border-color: var(--accent); }

        .track .pos {
            display: flex;
            align-items: center;
            gap: 8px;
            letter-spacing: 0.08em;
        }

        .track .names {
            display: grid;
            gap: 4px;
        }

        .track .names .song {
            font-weight: 700;
            letter-spacing: 0.04em;
        }

        .track .names .artist {
            font-size: 12px;
            color: var(--muted);
        }

        .track .controls {
            display: flex;
            gap: 8px;
        }

        .ghost-button {
            padding: 10px 12px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: rgba(255, 255, 255, 0.03);
            color: var(--text);
            letter-spacing: 0.08em;
            text-transform: uppercase;
            font-size: 11px;
            transition: border-color 0.2s ease, color 0.2s ease;
        }

        .ghost-button:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .context-menu {
            position: fixed;
            z-index: 70;
            background: rgba(12, 14, 20, 0.95);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 8px;
            min-width: 200px;
            box-shadow: var(--shadow);
        }

        .context-menu button {
            width: 100%;
            background: none;
            border: none;
            color: var(--text);
            padding: 10px 12px;
            border-radius: 10px;
            text-align: left;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            font-size: 11px;
            transition: background 0.2s ease, color 0.2s ease;
        }

        .context-menu button:hover {
            background: rgba(255, 255, 255, 0.06);
            color: var(--accent);
        }

        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.65);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 80;
            padding: 16px;
        }

        .modal {
            width: 100%;
            max-width: 640px;
            background: rgba(12, 14, 20, 0.92);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 20px;
            box-shadow: var(--shadow);
        }

        .modal h3 {
            font-size: 14px;
            margin-bottom: 12px;
        }

        .modal-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 12px;
            margin-top: 8px;
        }

        .label {
            font-size: 11px;
            letter-spacing: 0.1em;
            color: var(--muted);
            text-transform: uppercase;
        }

        .modal-actions {
            margin-top: 16px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .toast-stack {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 90;
            display: grid;
            gap: 10px;
        }

        .toast {
            padding: 12px 14px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: rgba(255, 255, 255, 0.08);
            letter-spacing: 0.06em;
        }

        .toast .title {
            font-weight: 700;
        }

        .toast .subtitle {
            font-size: 12px;
            color: var(--muted);
        }

        audio { display: none; }
        @media (max-width: 1100px) {
            .app-shell { grid-template-columns: 1fr; }
            .library { order: 2; }
            .main { order: 1; }
            .set-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
        }

        @media (max-width: 720px) {
            .track { grid-template-columns: 1fr; }
            .app-shell { padding: 14px; }
            .top-nav { flex-direction: column; align-items: flex-start; gap: 10px; }
            .set-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body class="app-body"
      x-data="tracklistify()"
      @keydown.window.escape="closeContextMenu()"
      @mousedown.window="handleContextMenuOutside($event)"
      @resize.window="positionContextMenu()">
<div class="app-shell">
    <aside class="sidebar glass-panel">
        <div class="sidebar-header">
            <div class="brand">
                <span class="brand-eyebrow">Tracklistify</span>
                <span class="brand-title">Studio</span>
            </div>
            <button class="icon-button" @click="createFolder()" title="New Folder">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h6l2 3h8v13H4z"/><path d="M12 11v6"/><path d="M9 14h6"/></svg>
            </button>
        </div>

        <div class="sidebar-section">
            <label class="label">Search</label>
            <input class="input-field" x-model="search" type="text" placeholder="Filter sets">
            <span class="hint">Drag sets into folders to organize them.</span>
        </div>

        <div class="flex-1 overflow-y-auto">
            <template x-for="set in filteredSets" :key="set.id">
                <button @click="loadSet(set)" @contextmenu.prevent="openContextMenu($event, { type: 'set', item: set })" class="w-full text-left px-4 py-3 border-b border-gray-200 last:border-b-0 hover:bg-gray-200/60 transition-all duration-150"
                        :class="activeSet && activeSet.id === set.id ? 'contrast-active rounded-lg shadow-md' : 'rounded-lg'">
                    <div class="flex items-center justify-between text-[12px] font-bold gap-2">
                        <div class="flex items-center gap-2 truncate">
                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7h18v10H3V7zm3-3h12v3H6V4z"/></svg>
                            <span class="truncate" x-text="folder.name"></span>
                        </div>
                        <span class="pill" x-text="(folder.sets?.length || 0) + 'x'"></span>
                    </div>
                </template>
                <div class="empty-hint" x-show="folders.length === 0" x-cloak>NO FOLDERS</div>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto divide-y divide-swiss">
            <div class="px-4 py-4 space-y-3">
                <div class="flex items-center justify-between text-[10px] font-bold">
                    <span>FOLDERS</span>
                    <button @click="createFolder()" class="swiss-button text-[10px] px-2 py-1">NEW</button>
                </div>

                <div class="space-y-2">
                    <template x-for="folder in folders" :key="folder.id">
                        <div class="px-3 py-2 border flex items-center justify-between text-[11px] gap-3 transition-colors"
                             :class="folderHoverId === folder.id ? 'folder-drop-target contrast-active' : 'folder-quiet accent-hover'"
                             @contextmenu.prevent="openFolderContextMenu($event, folder)"
                             @dragenter.prevent="onFolderDragEnter(folder, $event)" @dragover.prevent="onFolderDragOver($event)" @dragleave="onFolderDragLeave(folder)"
                             @drop.prevent="onDropToFolder(folder, $event)">
                            <div class="flex items-center gap-2 truncate">
                                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7h18M3 7a2 2 0 012-2h2m14 2v11a2 2 0 01-2 2H5a2 2 0 01-2-2V7m18 0l-3.34-4H8.34L5 7" /></svg>
                                <span class="truncate" x-text="folder.name"></span>
                            </div>
                            <span class="pill text-[10px]" x-text="(folder.sets?.length || 0) + ' SETS'"></span>
                        </div>
                    </template>
                    <div x-show="!folders.length" class="text-[11px] muted">NO FOLDERS</div>
                </div>

                <div class="border border-dashed px-3 py-4 text-center text-[11px] muted transition-colors"
                     style="border-color: var(--swiss-muted);"
                     :class="draggingSet ? 'contrast-active' : ''"
                     @dragover.prevent @dragenter.prevent @drop.prevent="onDropToTrash($event)">
                    DROP SET HERE TO DELETE
                </div>
            </div>
            <div class="set-list">
                <template x-for="set in filteredSets" :key="set.id">
                    <button @click="focusOnSet(set)"
                            @contextmenu.prevent="openContextMenu($event, 'set', set)"
                            draggable="true"
                            @dragstart="onDragSet(set, $event)"
                            @dragend="onDragEnd">
                        <div class="set-list-titles">
                            <span class="set-list-name" x-text="set.name"></span>
                            <span class="muted" x-text="formatDate(set.created_at)"></span>
                        </div>
                        <span class="pill" x-text="set.track_count + ' tracks'"></span>
                    </button>
                </template>
                <div class="empty-hint" x-show="sets.length === 0" x-cloak>NO SETS YET</div>
            </div>
        </div>

        <div class="trash-zone"
             :class="trashHover ? 'is-hovered' : ''"
             @dragenter.prevent="onTrashDragEnter($event)"
             @dragover.prevent="onTrashDragEnter($event)"
             @dragleave="onTrashDragLeave"
             @drop="onDropToTrash">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18"/><path d="M19 6l-1 14H6L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4h6v2"/></svg>
            <span>Trash Zone</span>
        </div>
        <div class="flex-1 overflow-y-auto" id="sets-list"></div>
    </aside>

    <main class="main-content">
        <header class="topbar glass-panel">
            <div class="topbar-left">
                <div class="logo-mark">
                    <div class="logo-ring">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 6h6l2 3h8v9H4z"/><circle cx="9" cy="13" r="2"/><circle cx="15" cy="13" r="2"/></svg>
                    </div>
                    <div class="logo-text">
                        <span>Tracklistify</span>
                        <span>Studio</span>
                    </div>
                </div>
                <div class="view-switcher">
                    <button class="chip-button" :class="currentView === 'dashboard' ? 'is-active' : ''" @click="showDashboard">Dashboard</button>
                    <button class="chip-button" :class="currentView === 'sets' ? 'is-active' : ''" @click="currentView = 'sets'">Sets</button>
                    <button class="chip-button" :class="currentView === 'queue' ? 'is-active' : ''" @click="showQueueView">Queue</button>
                    <button class="chip-button" :class="currentView === 'rescan' ? 'is-active' : ''" @click="showRescanView">Rescan</button>
                    <button class="chip-button" :class="currentView === 'likes' ? 'is-active' : ''" @click="showLikesView">Likes</button>
                </div>
            </div>
            <div class="topbar-actions">
                <button class="chip-button pill-link" @click="openAdmin">Admin</button>
                <template x-if="auth.user">
                    <div class="user-chip">
                        <div class="avatar" x-text="(auth.user.name || auth.user.dj_name || auth.user.email || 'DJ')[0]"></div>
                        <div class="names">
                            <div class="user-name" x-text="auth.user.name || auth.user.dj_name || auth.user.email"></div>
                            <div class="user-meta">Signed in</div>
                        </div>
                    </div>
                </template>
                <template x-if="!auth.user">
                    <a href="/login" class="chip-button pill-link">Guest</a>
                </template>
                <button class="cta" @click="ui.uploadTab = 'url'; ui.showAddModal = true">Add Set</button>
            </div>
        </header>

        <section class="panel" x-show="currentView === 'dashboard'" x-cloak>
            <div class="stat-grid">
                <template x-for="stat in statHighlights()" :key="stat.key">
                    <div class="stat-card">
                        <span class="label" x-text="stat.label"></span>
                        <span class="stat-value" x-text="stat.value"></span>
                    </div>
                </template>
            </div>
            <div class="panel">
                <div class="panel-header">
                    <h2>Recent Sets</h2>
                    <span class="hint">Drag to folders or open</span>
                </div>
                <div class="tile">
                    <div class="flex items-center justify-between mb-2">
                        <div class="text-[10px] font-bold">RECENT SETS</div>
                        <div class="flex items-center gap-2" x-show="uploadState.isProcessing">
                            <span class="px-2 py-0.5 rounded-full text-[10px] font-bold uppercase bg-orange-50 text-orange-600 border border-orange-200">Processing</span>
                            <span class="text-[10px] text-gray-500" x-text="processingLabel()"></span>
                        </div>
                    </div>
                    <div class="divide-y divide-swiss">
                        <template x-for="item in dashboardStats.recent_sets" :key="item.id">
                            <button class="w-full flex items-center justify-between py-3 text-left accent-hover cursor-move"
                                    draggable="true"
                                    @dragstart="onDragSet(item, $event)"
                                    @dragend="onDragEnd"
                                    @click="focusOnSet(item.id)">
                                <div class="flex flex-col">
                                    <span class="text-sm font-bold" x-text="item.name"></span>
                                    <span class="text-[10px] muted" x-text="formatDate(item.created_at)"></span>
                <div class="set-grid">
                    <template x-for="item in dashboardStats.recent_sets" :key="item.id">
                        <div class="set-card"
                             draggable="true"
                             @dragstart="onDragSet(item, $event)"
                             @dragend="onDragEnd"
                             @click="loadSet(item.id)"
                             @contextmenu.prevent="openSetContextMenu($event, item)">
                            <div class="set-thumb" :style="setCardBackground(item)">
                                <div class="set-thumb-fallback" x-show="!hasSetThumbnail(item)" x-text="(item.artists || item.dj_names || item.name || 'SET').slice(0, 6).toUpperCase()"></div>
                            </div>
                            <div class="set-meta">
                                <div class="set-pill">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 6h6l2 3h8v9H4z"/></svg>
                                    <span x-text="item.track_count + ' tracks'"></span>
                                </div>
                                <div class="set-title" x-text="item.name"></div>
                                <div class="set-artist" x-text="item.artists || item.dj_names || 'Unknown Artist'"></div>
                            </div>
                            <div class="set-footer">
                                <span x-text="formatDate(item.created_at)"></span>
                                <span x-text="item.event || 'Ready'"></span>
                            </div>
                        </div>
                    </template>
                    <div class="empty-card" x-show="!dashboardStats.recent_sets.length" x-cloak>No recent sets</div>
                </div>
            </div>
        </section>

        <div class="content">
            <div class="section-header">
                <div style="display:flex; align-items:center; gap:10px;">
                    <h2 x-text="ui.trackViewOnly ? 'Tracklist' : 'Sets'"></h2>
                    <span class="hint" x-show="!ui.trackViewOnly">Right-click for quick actions</span>
                    <span class="hint" x-show="ui.trackViewOnly && activeSet" x-text="activeSet.name"></span>
                </div>
                <div class="flex-1 overflow-auto">
                    <table class="table-grid text-xs">
                        <thead>
                            <tr>
                                <th class="w-10">#</th>
                                <th class="w-16">PLAY</th>
                                <th class="w-20 text-right">TIME</th>
                                <th class="text-left">TRACK</th>
                                <th class="w-16 text-right">CONF</th>
                                <th class="w-24 text-center">SHOPS</th>
                                <th class="w-24 text-center">BOUGHT</th>
                                <th class="w-12 text-center">FAV</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="(track, index) in tracks" :key="track.id">
                                <tr class="border-b border-gray-100 hover:bg-gray-100/60 transition-colors" @contextmenu.prevent="openContextMenu($event, { type: 'track', item: track })">
                                    <td class="px-2 py-3 text-center">
                                        <button @click.stop="toggleFlag(track)" class="text-[11px] font-bold" :class="track.flag === 3 ? 'text-red-600' : ''" x-text="track.flag === 3 ? '???' : track.position"></button>
                                    </td>
                                    <td class="text-center">
                                        <button @click.stop="togglePlay(track)" class="w-8 h-8 border flex items-center justify-center">
                                            <div x-show="ui.loadingId === track.id" class="animate-spin h-4 w-4 border border-t-transparent"></div>
                                            <svg x-show="ui.playingId !== track.id && ui.loadingId !== track.id" class="w-4 h-4 fill-current" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                                            <svg x-show="ui.playingId === track.id" class="w-4 h-4 fill-current" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                                        </button>
                                    </td>
                                    <td class="text-right font-mono" x-text="formatTime(track.start_time)"></td>
                                    <td>
                                        <div class="flex flex-col gap-1">
                                            <div class="flex items-baseline gap-2">
                                                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-2v13M5 7h2m-2 5h2m-2 5h2"/></svg>
                                                <span class="text-sm font-bold" x-text="track.title || 'UNKNOWN'"></span>
                                                <span class="text-[11px] muted" x-text="track.artist || 'UNKNOWN'"></span>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="text-right text-[10px] font-bold" x-text="formatConf(track.confidence)"></td>
                                    <td class="text-center">
                                        <div class="flex justify-center gap-2">
                                            <a :href="getSearchLink(track, 'youtube')" target="_blank" class="underline">YT</a>
                                            <a :href="getSearchLink(track, 'beatport')" target="_blank" class="underline">BP</a>
                                        </div>
                                    </td>
                                    <td class="text-center">
                                        <button @click.stop="togglePurchase(track)" class="swiss-button text-[10px] px-2 py-1" x-text="track.purchased ? 'YES' : 'NO'"></button>
                                    </td>
                                    <td class="text-center">
                                        <button @click.stop="toggleLike(track)" :class="track.liked ? 'contrast-active' : ''" class="px-2 py-1">
                                            <svg class="w-5 h-5" :fill="track.liked ? 'currentColor' : 'none'" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" /></svg>
                                        </button>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                    <div x-show="!activeSet" class="p-8 text-center text-[12px] muted">SELECT A SET TO SEE TRACKS</div>
                </div>
            </div>
            <div class="set-grid" x-show="!ui.trackViewOnly">
                <template x-for="set in filteredSets" :key="set.id">
                    <div class="set-card"
                         draggable="true"
                         @dragstart="onDragSet(set, $event)"
                         @dragend="onDragEnd"
                         @dragenter.prevent="onCardDragEnter(set)"
                         @dragover.prevent="onCardDragOver($event)"
                         @dragleave="onCardDragLeave(set)"
                         @drop.prevent="onCardDrop(set, $event)"
                         @click="focusOnSet(set)"
                         @contextmenu.prevent="openSetContextMenu($event, set)"
                         :class="setCardClasses(set)">
                        <div class="set-thumb" :style="set.thumbnail ? `background-image:url(${set.thumbnail})` : ''">
                            <div class="fallback" x-show="!set.thumbnail" x-text="(set.artists || set.dj_names || set.name || 'SET').slice(0, 6).toUpperCase()"></div>
                        </div>
                        <div class="set-meta">
                            <div class="set-pill">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 6h6l2 3h8v9H4z"/></svg>
                                <span x-text="set.track_count + ' tracks'"></span>
                            </div>
                            <div class="set-title" x-text="set.name"></div>
                            <div class="set-artist" x-text="set.artists || set.dj_names || 'Unknown Artist'"></div>
                            <div class="set-progress" aria-hidden="true">
                                <span :style="`width:${setProgress(set)}%`"></span>
                            </div>
                        </div>
                        <div class="set-footer">
                            <span x-text="formatDate(set.created_at)"></span>
                            <span class="tag" x-text="set.event || setFolderLabel(set)"></span>
                        </div>
                    </div>
                </template>
                <div class="empty-card" x-show="filteredSets.length === 0" x-cloak>No sets yet</div>
            </div>

            <div class="track-panel" :class="ui.trackViewOnly && activeSet ? 'focused' : ''">
                <div class="track-panel-header">
                    <div class="title">
                        <span>Active Set</span>
                        <span x-text="activeSet ? activeSet.name : 'Select a set to view tracks'"></span>
                    </div>
                    <div class="controls" style="display:flex; gap:8px;"></div>
                </div>
                <div class="tracklist" x-show="activeSet" x-cloak>
                    <template x-for="(track, index) in tracks" :key="track.id">
                        <div class="track-row">
                            <div class="track-position">
                                <button class="icon-button compact" @click.stop="togglePlay(track)">
                                    <svg x-show="ui.playingId !== track.id" width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
                                    <svg x-show="ui.playingId === track.id" width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                                </button>
                                <span x-text="track.flag === 3 ? '???' : (track.position || index + 1)"></span>
                            </div>
                            <div class="track-names">
                                <div class="track-title" x-text="track.title || 'Unknown Track'"></div>
                                <div class="track-artist" x-text="track.artist || 'Unknown Artist'"></div>
                            </div>
                            <div class="track-meta">
                                <span class="muted">Start</span>
                                <strong x-text="formatTime(track.start_time)"></strong>
                            </div>
                            <div class="track-meta">
                                <span class="muted">Confidence</span>
                                <strong x-text="formatConf(track.confidence)"></strong>
                            </div>
                            <div class="track-controls">
                                <button class="ghost-button" @click.stop="togglePurchase(track)" x-text="track.purchased ? 'Bought' : 'Buy'"></button>
                                <button class="ghost-button" @click.stop="toggleLike(track)">
                                    <span x-text="track.liked ? 'Liked' : 'Like'"></span>
                                </button>
                            </div>
                        </div>
                    </template>
                </div>
                <div class="empty-hint" x-show="!activeSet" x-cloak>Choose a set to see its tracks.</div>
            </div>
        </section>

        <section class="panel" x-show="currentView === 'queue'" x-cloak>
            <div class="panel-header">
                <h2>Queue</h2>
                <button class="ghost-button" @click="stopQueue">Stop Active</button>
            </div>
            <div class="queue-state">
                <div>
                    <span class="label">Active</span>
                    <div class="value" x-text="queueStatus.active?.label || 'None'"></div>
                </div>
                <div>
                    <span class="label">Waiting</span>
                    <div class="value" x-text="queueStatus.queue?.length || 0"></div>
                </div>
                <div>
                    <span class="label">Finished</span>
                    <div class="value" x-text="queueStatus.history?.length || 0"></div>
                </div>
            </div>
            <div class="panel">
                <div class="panel-header">
                    <h3>Upcoming</h3>
                </div>
                <div class="set-list">
                    <template x-for="job in queueStatus.queue" :key="job.id">
                        <div class="set-list-item">
                            <div class="set-list-titles">
                                <span class="set-list-name" x-text="job.label"></span>
                                <span class="muted" x-text="job.phase"></span>
                            </div>
                            <span class="pill" x-text="job.progress ? Math.round(job.progress) + '%' : 'Queued'"></span>
                        </div>
                    </template>
                    <div class="empty-hint" x-show="!queueStatus.queue || !queueStatus.queue.length" x-cloak>No pending jobs</div>
                </div>
            </div>
        </section>

        <section class="panel" x-show="currentView === 'rescan'" x-cloak>
            <div class="panel-header">
                <h2>Rescan Candidates</h2>
                <button class="ghost-button" @click="runRescan">Run Rescan</button>
            </div>
            <div class="set-list">
                <template x-for="track in rescanCandidates" :key="track.id">
                    <div class="set-list-item">
                        <div class="set-list-titles">
                            <span class="set-list-name" x-text="track.title"></span>
                            <span class="muted" x-text="track.artist"></span>
                        </div>
                        <button class="chip-button" @click="toggleFlag(track)">Toggle Flag</button>
                    </div>
                </template>
                <div class="empty-hint" x-show="!rescanCandidates || !rescanCandidates.length" x-cloak>No tracks marked for rescan.</div>
            </div>
        </section>

        <section class="panel" x-show="currentView === 'likes'" x-cloak>
            <div class="panel-header">
                <h2>Likes & Purchases</h2>
            </div>
            <div class="set-list">
                <template x-for="track in likedTracks" :key="track.id">
                    <div class="set-list-item">
                        <div class="set-list-titles">
                            <span class="set-list-name" x-text="track.title"></span>
                            <span class="muted" x-text="track.artist"></span>
                        </div>
                        <span class="pill">Liked</span>
                    </div>
                </template>
                <div class="empty-hint" x-show="!likedTracks || !likedTracks.length" x-cloak>No liked tracks yet.</div>
            </div>
        </section>
    </main>
</div>

<div x-show="ui.contextMenu.show" x-ref="contextMenu" x-cloak
     class="context-menu glass-panel"
     @contextmenu.prevent
     @click.outside="closeContextMenu()"
     :style="'top: ' + ui.contextMenu.y + 'px; left: ' + ui.contextMenu.x + 'px'">
    <div class="context-menu-header">
        <span x-text="ui.contextMenu.type === 'folder' ? 'FOLDER ACTIONS' : 'SET ACTIONS'"></span>
    </div>
    <template x-if="ui.contextMenu.type === 'set'">
        <div class="py-1 space-y-1">
            <button @click="handleContextAction('edit')" class="w-full text-left px-4 py-2 text-[12px] hover:bg-gray-100 flex items-center gap-2">
                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                <span>Info & Tags</span>
            </button>
            <button @click="handleContextAction('rename')" class="w-full text-left px-4 py-2 text-[12px] hover:bg-gray-100 flex items-center gap-2">
                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                <span>Umbenennen</span>
            </button>
            <button @click="handleContextAction('move')" class="w-full text-left px-4 py-2 text-[12px] hover:bg-gray-100 flex items-center gap-2">
                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h7" /></svg>
                <span>In Ordner verschieben</span>
            </button>
            <div x-show="folders.length" class="pt-1">
                <div class="px-4 py-1 text-[10px] muted">Oder hierhin bewegen</div>
                <template x-for="folder in folders" :key="folder.id">
                    <button @click="moveSetToFolderFromMenu(folder)" class="w-full text-left px-4 py-2 text-[12px] hover:bg-gray-100 flex items-center gap-2">
                        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7h18M3 7a2 2 0 012-2h2m14 2v11a2 2 0 01-2 2H5a2 2 0 01-2-2V7m18 0l-3.34-4H8.34L5 7" /></svg>
                        <span class="truncate" x-text="folder.name"></span>
                    </button>
                </template>
            </div>
            <button @click="handleContextAction('rescan')" class="w-full text-left px-4 py-2 text-[12px] hover:bg-gray-100 flex items-center gap-2">
                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
                <span>Neu analysieren</span>
            </button>
            <button @click="handleContextAction('delete')" class="w-full text-left px-4 py-2 text-[12px] hover:bg-gray-100 flex items-center gap-2 text-red-600">
                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                <span>Set l√∂schen</span>
            </button>
        </div>
    </template>

    <template x-if="ui.contextMenu.type === 'folder'">
        <div class="py-1 space-y-1">
            <button @click="handleContextAction('rename')" class="w-full text-left px-4 py-2 text-[12px] hover:bg-gray-100 flex items-center gap-2">
                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6l4 2" /></svg>
                <span>Ordner umbenennen</span>
            </button>
            <button @click="handleContextAction('delete')" class="w-full text-left px-4 py-2 text-[12px] hover:bg-gray-100 flex items-center gap-2 text-red-600">
                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4" /></svg>
                <span>Ordner l√∂schen</span>
            </button>
        </div>
    </template>
</div>

<!-- Context Menu -->
<div x-show="ui.contextMenu.show"
     @click.away="closeContextMenu()"
     x-cloak
     class="fixed bg-white border border-gray-200 shadow-xl rounded-xl py-1 w-56 z-50 overflow-hidden animate-row"
     :style="'top: ' + ui.contextMenu.y + 'px; left: ' + ui.contextMenu.x + 'px'">

    <div class="px-4 py-2 text-[10px] font-bold text-gray-400 bg-gray-50 border-b border-gray-100 uppercase tracking-wider mb-1" x-text="ui.contextMenu.type === 'track' ? 'Track Optionen' : 'Set Optionen'"></div>

    <template x-if="ui.contextMenu.type === 'set'">
        <div class="flex flex-col">
            <button @click="openEditSetModal()" class="w-full text-left px-4 py-2.5 text-sm text-gray-700 hover:bg-orange-50 hover:text-orange-700 flex items-center gap-2 transition-colors">
                <svg class="w-4 h-4 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                Info / Tags
            </button>

            <button @click="rescanSetContext()" class="w-full text-left px-4 py-2.5 text-sm text-gray-700 hover:bg-orange-50 hover:text-orange-700 flex items-center gap-2 transition-colors">
                <svg class="w-4 h-4 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
                Neu analysieren
            </button>

            <button @click="renameItem()" class="w-full text-left px-4 py-2.5 text-sm text-gray-700 hover:bg-orange-50 hover:text-orange-700 flex items-center gap-2 transition-colors">
                <svg class="w-4 h-4 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                Umbenennen
            </button>

            <button @click="showDetails()" class="w-full text-left px-4 py-2.5 text-sm text-gray-700 hover:bg-orange-50 hover:text-orange-700 flex items-center gap-2 transition-colors">
                <svg class="w-4 h-4 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                Details anzeigen
            </button>

            <div class="border-t border-gray-100 my-1"></div>

            <button @click="deleteItem()" class="w-full text-left px-4 py-2.5 text-sm text-red-600 hover:bg-red-50 flex items-center gap-2 transition-colors">
                <svg class="w-4 h-4 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                L√∂schen
            </button>
        </div>
    </template>

    <template x-if="ui.contextMenu.type === 'track'">
        <div class="flex flex-col">
            <button @click="renameItem()" class="w-full text-left px-4 py-2.5 text-sm text-gray-700 hover:bg-orange-50 hover:text-orange-700 flex items-center gap-2 transition-colors">
                <svg class="w-4 h-4 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                Umbenennen
            </button>

            <button @click="showDetails()" class="w-full text-left px-4 py-2.5 text-sm text-gray-700 hover:bg-orange-50 hover:text-orange-700 flex items-center gap-2 transition-colors">
                <svg class="w-4 h-4 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                Details anzeigen
            </button>

            <div class="border-t border-gray-100 my-1"></div>

            <button @click="deleteItem()" class="w-full text-left px-4 py-2.5 text-sm text-red-600 hover:bg-red-50 flex items-center gap-2 transition-colors">
                <svg class="w-4 h-4 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                L√∂schen
            </button>
        </div>
    </template>

    <div class="border-t border-gray-100 mt-1 pt-1">
        <div class="px-4 py-2 text-[10px] font-bold text-gray-500 uppercase tracking-wider">Ordner</div>
        <template x-if="folders.length">
            <div class="flex flex-col">
                <template x-for="folder in folders" :key="folder.id">
                    <button @click="moveItemToFolder(folder)" class="w-full text-left px-4 py-2.5 text-sm text-gray-700 hover:bg-orange-50 hover:text-orange-700 flex items-center gap-2 transition-colors">
                        <svg class="w-4 h-4 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 7h18M3 12h18M3 17h18" /></svg>
                        <span x-text="folder.name"></span>
                    </button>
                </template>
            </div>
        </template>
        <div x-show="!folders.length" class="px-4 py-2 text-xs text-gray-500">Keine Ordner definiert.</div>
    </div>
</div>

<!-- Detail Panel -->
<div x-show="ui.detailPanel.show" x-cloak class="fixed inset-0 z-40 flex items-stretch justify-end">
    <div class="flex-1 bg-black/30" @click="closeDetailPanel()"></div>
    <div class="w-full max-w-md bg-white border-l border-gray-200 shadow-2xl overflow-y-auto p-6 space-y-4">
        <div class="flex items-center justify-between">
            <div>
                <div class="text-[10px] font-bold text-gray-500 uppercase" x-text="ui.detailPanel.type === 'track' ? 'Track Details' : 'Set Details'"></div>
                <div class="text-lg font-bold" x-text="ui.detailPanel.item && (ui.detailPanel.item.title || ui.detailPanel.item.name)"></div>
            </div>
            <button @click="closeDetailPanel()" class="px-3 py-1 border border-gray-200 text-xs font-bold">Close</button>
        </div>

        <template x-if="ui.detailPanel.type === 'set' && ui.detailPanel.item">
            <div class="space-y-2 text-sm">
                <div class="flex justify-between">
                    <span class="text-gray-500">Artists</span>
                    <span class="font-semibold" x-text="ui.detailPanel.item.artists || '-' "></span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-500">Event</span>
                    <span class="font-semibold" x-text="ui.detailPanel.item.event || '-' "></span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-500">Tags</span>
                    <span class="font-semibold" x-text="ui.detailPanel.item.tags || '-' "></span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-500">Tracks</span>
                    <span class="font-semibold" x-text="ui.detailPanel.item.track_count || tracks.length"></span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-500">Erstellt</span>
                    <span class="font-semibold" x-text="formatDate(ui.detailPanel.item.created_at)"></span>
                </div>
            </div>
        </template>

        <template x-if="ui.detailPanel.type === 'track' && ui.detailPanel.item">
            <div class="space-y-2 text-sm">
                <div class="flex justify-between">
                    <span class="text-gray-500">Artist</span>
                    <span class="font-semibold" x-text="ui.detailPanel.item.artist || '-' "></span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-500">Set</span>
                    <span class="font-semibold" x-text="ui.detailPanel.item.set_name || (activeSet ? activeSet.name : '-')"></span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-500">Start</span>
                    <span class="font-semibold" x-text="formatTime(ui.detailPanel.item.start_time)"></span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-500">Confidence</span>
                    <span class="font-semibold" x-text="formatConf(ui.detailPanel.item.confidence)"></span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-500">Gekauft</span>
                    <span class="font-semibold" x-text="ui.detailPanel.item.purchased ? 'Ja' : 'Nein'"></span>
                </div>
            </div>
        </template>
    </div>
</div>

<!-- Add Set Modal -->
<div x-show="ui.showAddModal" x-cloak class="fixed inset-0 z-[80] flex items-center justify-center">
    <div class="fixed inset-0 bg-black/70" @click="ui.showAddModal = false"></div>
    <div class="bg-white border w-full max-w-2xl p-6 space-y-4 z-10 rounded-2xl shadow-xl">
        <div class="flex items-center justify-between gap-3">
            <div class="text-sm font-bold uppercase tracking-wide text-gray-800">Import Set</div>
            <div class="flex items-center gap-2" x-show="uploadState.isProcessing">
                <span class="px-2 py-1 rounded-full text-[10px] font-bold uppercase bg-orange-50 text-orange-600 border border-orange-200">Processing</span>
                <span class="text-[11px] text-gray-500" x-text="queueStatus.active ? queueStatus.active.label : 'Waiting jobs'"></span>
<div x-show="ui.showAddModal" x-cloak class="modal-backdrop">
    <div class="modal glass-panel">
        <div class="modal-header">
            <h3>Import Set</h3>
            <button class="icon-button" @click="ui.showAddModal = false">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18"/><path d="M6 6l12 12"/></svg>
            </button>
        </div>
        <div class="modal-tabs">
            <button class="tab" :class="ui.uploadTab === 'url' ? 'is-active' : ''" @click="ui.uploadTab = 'url'">URL</button>
            <button class="tab" :class="ui.uploadTab === 'file' ? 'is-active' : ''" @click="ui.uploadTab = 'file'">File</button>
        </div>

        <div class="modal-content">
            <div class="modal-row" x-show="ui.uploadTab === 'url'" x-cloak>
                <label class="label">Source URL</label>
                <div class="input-row">
                    <input type="text" class="input-field" x-model="inputs.url" placeholder="https://...">
                    <button class="ghost-button" @click="fetchUrlMetadata(inputs.url)" :disabled="inputs.isLoadingMeta">Fetch</button>
                </div>
            </div>

            <div class="modal-row" x-show="ui.uploadTab === 'file'" x-cloak>
                <label class="label">Audio File</label>
                <input type="file" class="input-field" x-ref="fileInput" @change="inputs.file = $refs.fileInput.files[0]; parseFileMetadata();">
            </div>

            <div class="modal-grid">
                <div class="modal-field">
                    <label class="label">Artist / DJ</label>
                    <input type="text" class="input-field" x-model="inputs.metaArtist">
                </div>
                <div class="modal-field">
                    <label class="label">Title</label>
                    <input type="text" class="input-field" x-model="inputs.metaName">
                </div>
                <div class="modal-field">
                    <label class="label">Event / Info</label>
                    <input type="text" class="input-field" x-model="inputs.metaEvent">
                </div>
                <div class="modal-field">
                    <label class="label">Tags</label>
                    <input type="text" class="input-field" x-model="inputs.metaTags">
                </div>
            </div>

            <div class="modal-row inline">
                <label class="checkbox">
                    <input type="checkbox" x-model="inputs.is_b2b">
                    <span>B2B</span>
                </label>
                <span class="hint" x-text="queueStatus.queue.length + ' waiting'"></span>
            </div>
        </div>

        <div class="modal-actions">
            <button class="ghost-button" @click="ui.showAddModal = false">Close</button>
            <button class="cta" @click="addToQueue(ui.uploadTab)" :disabled="ui.uploadTab === 'url' ? !inputs.url : !inputs.file">Start</button>
        </div>
    </div>
</div>

<div x-show="ui.showEditSetModal" x-cloak class="modal-backdrop">
    <div class="modal glass-panel">
        <div class="modal-header">
            <h3>Edit Set</h3>
            <button class="icon-button" @click="ui.showEditSetModal = false">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18"/><path d="M6 6l12 12"/></svg>
            </button>
        </div>

        <div class="flex gap-2 bg-gray-50 border border-gray-200 rounded-xl p-1 text-[12px] font-bold uppercase tracking-wide">
            <button class="flex-1 py-2 rounded-lg transition-colors"
                    :class="uploadState.tab === 'url' ? 'bg-white text-orange-600 shadow-sm' : 'text-gray-500'"
                    @click="uploadManager.setTab('url')">URL</button>
            <button class="flex-1 py-2 rounded-lg transition-colors"
                    :class="uploadState.tab === 'file' ? 'bg-white text-orange-600 shadow-sm' : 'text-gray-500'"
                    @click="uploadManager.setTab('file')">File</button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="space-y-3" x-show="uploadState.tab === 'url'">
                <label class="text-[10px] font-bold text-gray-500">Paste URL</label>
                <div class="flex gap-2">
                    <input type="text"
                           :value="inputs.url"
                           @input="uploadManager.handleUrlInput($event.target.value)"
                           @paste.prevent="uploadManager.handlePaste($event)"
                           placeholder="YouTube / Mixcloud / SoundCloud ..."
                           class="flex-1 swiss-input text-[11px]">
                    <button @click="fetchUrlMetadata(inputs.url)"
                            class="swiss-button text-[11px] flex items-center gap-2"
                            :class="inputs.isLoadingMeta ? 'opacity-60 pointer-events-none' : ''">
                        <svg x-show="inputs.isLoadingMeta" class="w-4 h-4 animate-spin" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 12a8 8 0 018-8"/></svg>
                        <span>Fetch</span>
                    </button>
                </div>
                <p class="text-[11px] text-gray-500 leading-tight">Smart metadata lookup will prefill details after you paste or type.</p>
            </div>

            <div class="space-y-3" x-show="uploadState.tab === 'file'">
                <label class="text-[10px] font-bold text-gray-500">Upload file</label>
                <input type="file"
                       x-ref="fileInput"
                       @change="uploadManager.handleFileChange($event.target.files[0])"
                       class="flex-1 swiss-input text-[11px]">
                <p class="text-[11px] text-gray-500 leading-tight">Drop a local recording to analyse. We will extract hints from the filename automatically.</p>
            </div>
        </div>

        <div class="modal-grid">
            <div class="modal-field">
                <label class="label">Name</label>
                <input type="text" class="input-field" x-model="editSetData.name">
            </div>
            <div class="modal-field">
                <label class="label">Artists</label>
                <input type="text" class="input-field" x-model="editSetData.artists">
            </div>
            <div class="modal-field">
                <label class="label">Event</label>
                <input type="text" class="input-field" x-model="editSetData.event">
            </div>
            <div class="modal-field">
                <label class="label">Tags</label>
                <input type="text" class="input-field" x-model="editSetData.tags">
            </div>
        </div>
        <div class="modal-row inline">
            <label class="checkbox">
                <input type="checkbox" x-model="editSetData.is_b2b">
                <span>B2B</span>
            </label>
            <span class="hint" x-text="queueStatus.queue_count ? queueStatus.queue_count + ' waiting' : 'Queue idle'"></span>
        </div>
        <div class="modal-actions">
            <button class="ghost-button" @click="ui.showAddModal = false">Close</button>
            <button class="cta"
                    :disabled="uploadState.isSubmitting || (uploadState.tab === 'url' ? !inputs.url : !inputs.file)"
                    :class="uploadState.isSubmitting ? 'opacity-60 pointer-events-none' : ''"
                    @click="uploadManager.submit()">
                <span x-text="uploadState.tab === 'url' ? 'Submit URL' : 'Upload File'"></span>
            </button>
        </div>
        <div class="modal-actions">
            <button class="ghost-button" @click="ui.showEditSetModal = false">Cancel</button>
            <button class="cta" @click="saveSetMetadata">Save</button>
        </div>
    </div>
</div>

<div x-show="ui.showProfileModal" x-cloak class="modal-backdrop">
    <div class="modal glass-panel">
        <div class="modal-header">
            <h3>Edit Profile</h3>
            <button class="icon-button" @click="ui.showProfileModal = false">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18"/><path d="M6 6l12 12"/></svg>
            </button>
        </div>
        <div class="modal-grid">
            <div class="modal-field">
                <label class="label">Name</label>
                <input type="text" class="input-field" x-model="profile.display_name">
            </div>
            <div class="modal-field">
                <label class="label">DJ Name</label>
                <input type="text" class="input-field" x-model="profile.dj_name">
            </div>
            <div class="modal-field">
                <label class="label">SoundCloud</label>
                <input type="text" class="input-field" x-model="profile.soundcloud_url">
            </div>
            <div class="modal-field">
                <label class="label">Avatar</label>
                <input type="file" class="input-field" x-ref="avatarInput">
            </div>
        </div>
        <div class="modal-actions">
            <button class="ghost-button" data-action="close-upload">Cancel</button>
            <button class="cta" data-action="submit-upload">Start</button>
        </div>
    </div>
</div>

<div x-show="admin.show" x-cloak class="modal-backdrop">
    <div class="modal glass-panel">
        <div class="modal-header">
            <h3>Admin Console</h3>
            <button class="icon-button" @click="admin.show = false">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18"/><path d="M6 6l12 12"/></svg>
            </button>
        </div>
        <div class="modal-grid">
            <div class="modal-field">
                <label class="label">Username</label>
                <input type="text" class="input-field" x-model="admin.invite.username">
            </div>
            <div class="modal-field">
                <label class="label">Password</label>
                <input type="text" class="input-field" x-model="admin.invite.password">
            </div>
            <div class="modal-field">
                <label class="label">Temp Password</label>
                <input type="text" class="input-field" x-model="admin.invite.generated" readonly>
            </div>
        </div>
        <div class="modal-actions">
            <button class="ghost-button" @click="inviteUser">Invite User</button>
            <button class="ghost-button" @click="admin.show = false">Close</button>
        </div>
        <div class="set-list">
            <template x-for="user in admin.users" :key="user.id">
                <div class="set-list-item">
                    <div class="set-list-titles">
                        <span class="set-list-name" x-text="user.username"></span>
                        <span class="muted" x-text="formatDate(user.created_at)"></span>
                    </div>
                    <button class="chip-button" @click="deleteUser(user.id)">Delete</button>
                </div>
            </template>
            <div class="empty-hint" x-show="!admin.users || !admin.users.length" x-cloak>No users yet.</div>
        </div>
    </div>
</div>

<div class="toast-stack">
    <template x-for="toast in toasts" :key="toast.id">
        <div class="toast glass-panel">
            <div class="toast-title" x-text="toast.title"></div>
            <div class="toast-subtitle" x-text="toast.subtitle"></div>
        </div>
    </template>
</div>

<footer class="player-bar glass-panel" x-show="activeTrack" x-cloak>
    <div class="player-meta">
        <button class="icon-button compact" @click="togglePlayPauseGlobal">
            <svg x-show="audio.paused" width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
            <svg x-show="!audio.paused" width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
        </button>
        <div class="player-text">
            <div class="player-title" x-text="activeTrack?.title || 'Now Playing'"></div>
            <div class="player-artist" x-text="activeTrack?.artist || activeSet?.name"></div>
        </div>
    </div>
    <div class="player-progress" @click="seekGlobal">
        <div class="progress-bar">
            <div class="progress-fill" :style="`width: ${audio.progressPercent || 0}%`"></div>
        </div>
        <div class="progress-times">
            <span x-text="formatTime(audio.currentTime)"></span>
            <span x-text="formatTime(audio.duration)"></span>
        </div>
    </div>
</footer>

<audio x-ref="player" @timeupdate="updateProgress" @ended="onAudioEnded" @pause="onAudioPaused" @play="onAudioPlaying" @error="onAudioError"></audio>
</body>
</html>


================================================
DATEI: static/css/style.css
================================================
:root {
  --bg: #0a0a0a;
  --bg-soft: #0e0e0f;
  --ink: #f6f7fb;
  --ink-subtle: #c7cedd;
  --muted: #9aa2b3;
  --accent: #ff5500;
  --accent-strong: #ff7a32;
  --panel: rgba(255, 255, 255, 0.04);
  --panel-strong: rgba(255, 255, 255, 0.08);
  --border: rgba(255, 255, 255, 0.12);
  --border-strong: rgba(255, 85, 0, 0.4);
  --radius: 16px;
  --shadow: 0 26px 90px rgba(0, 0, 0, 0.72);
  --grid-gap: 1rem;
  --sidebar-width: 260px;
  --card-height: 280px;
  --font-family: 'Inter', 'Helvetica Neue', Helvetica, Arial, sans-serif;
}

* {
  box-sizing: border-box;
}

body {
  margin: 0;
  min-height: 100vh;
  background: radial-gradient(circle at 18% 22%, rgba(255, 85, 0, 0.12), transparent 28%),
              radial-gradient(circle at 82% 8%, rgba(255, 255, 255, 0.06), transparent 26%),
              var(--bg);
  color: var(--ink);
  font-family: var(--font-family);
  line-height: 1.6;
  letter-spacing: 0.03em;
  -webkit-font-smoothing: antialiased;
}

::selection {
  background: color-mix(in srgb, var(--accent) 72%, transparent);
  color: var(--ink);
}

[x-cloak] {
  display: none !important;
}

a {
  color: inherit;
  text-decoration: none;
  transition: color 0.2s ease;
}

a:hover {
  color: var(--accent);
}

h1, h2, h3, h4, h5, h6 {
  margin: 0;
  font-weight: 800;
  letter-spacing: 0.08em;
  text-transform: uppercase;
}

.hint {
  font-size: 0.78rem;
  color: var(--muted);
  letter-spacing: 0.08em;
  text-transform: uppercase;
}

button {
  font-family: inherit;
  cursor: pointer;
}

.swiss-shell {
  display: grid;
  grid-template-columns: var(--sidebar-width) 1fr;
  gap: 1.25rem;
  padding: 1.5rem;
  min-height: 100vh;
  background: linear-gradient(140deg, rgba(255, 255, 255, 0.02), rgba(255, 255, 255, 0.01));
}

.swiss-sidebar {
  position: sticky;
  top: 1.5rem;
  align-self: flex-start;
  width: var(--sidebar-width);
  min-height: calc(100vh - 3rem);
  display: flex;
  flex-direction: column;
  gap: 1rem;
  border-radius: var(--radius);
  background: linear-gradient(165deg, var(--panel-strong), var(--panel));
  border: 1px solid var(--border);
  box-shadow: var(--shadow);
  padding: 1rem;
  backdrop-filter: blur(12px) saturate(1.05);
  -webkit-backdrop-filter: blur(12px) saturate(1.05);
}

.swiss-section {
  border: 1px solid var(--border);
  background: var(--panel);
  border-radius: calc(var(--radius) - 6px);
  padding: 1rem;
  display: grid;
  gap: 0.75rem;
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
}

.swiss-header {
  border: 1px solid var(--border);
  border-radius: calc(var(--radius) - 6px);
  padding: 1rem 1.25rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: linear-gradient(120deg, var(--panel-strong), var(--panel));
  backdrop-filter: blur(12px) saturate(1.05);
  -webkit-backdrop-filter: blur(12px) saturate(1.05);
  box-shadow: var(--shadow);
  gap: 1rem;
}

.swiss-brand {
  display: grid;
  gap: 0.15rem;
  line-height: 1;
  text-transform: uppercase;
}

.swiss-brand span:first-child {
  font-size: 0.72rem;
  letter-spacing: 0.32em;
  color: var(--muted);
}

.swiss-brand span:last-child {
  font-size: 1rem;
  font-weight: 800;
  letter-spacing: 0.16em;
}

.swiss-input,
.swiss-select,
.input {
  width: 100%;
  padding: 0.8rem 0.95rem;
  border: 1px solid var(--border);
  background: rgba(255, 255, 255, 0.03);
  color: var(--ink);
  font-size: 0.9rem;
  font-weight: 700;
  letter-spacing: 0.05em;
  text-transform: uppercase;
  border-radius: calc(var(--radius) - 8px);
  transition: border-color 0.25s ease, box-shadow 0.25s ease, background 0.25s ease, transform 0.2s ease;
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  caret-color: var(--accent);
}

.swiss-input::placeholder,
.swiss-select::placeholder,
.input::placeholder {
  color: var(--muted);
}

.swiss-input:focus-visible,
.swiss-select:focus-visible,
.input:focus-visible {
  border-color: var(--accent);
  outline: none;
  background: color-mix(in srgb, var(--panel) 80%, var(--accent));
  box-shadow: 0 0 0 1px var(--accent), 0 16px 40px rgba(255, 85, 0, 0.3);
  transform: translate3d(0, -1px, 0);
}

.swiss-button,
button,
.nav-button,
.cta,
.ghost-button {
  border: 1px solid var(--border-strong);
  background: linear-gradient(180deg, var(--panel-strong), var(--panel));
  color: var(--ink);
  font-weight: 800;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  padding: 0.7rem 1rem;
  border-radius: calc(var(--radius) - 8px);
  transition: background 0.2s ease, color 0.2s ease, transform 0.2s ease, border-color 0.2s ease, box-shadow 0.3s ease;
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  will-change: transform;
}

.swiss-button:hover,
button:hover,
.nav-button:hover,
.cta:hover,
.ghost-button:hover {
  background: color-mix(in srgb, var(--panel) 65%, var(--accent));
  border-color: var(--accent);
  color: #0b0b0b;
  box-shadow: var(--shadow), 0 0 0 1px rgba(255, 85, 0, 0.4);
  transform: translate3d(0, -2px, 0);
}

.swiss-button:active,
button:active,
.nav-button:active,
.cta:active,
.ghost-button:active {
  transform: translate3d(0, 0, 0);
  background: var(--accent);
  color: #0b0b0b;
  box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.18);
  border-color: var(--accent);
}

.cta {
  background: linear-gradient(180deg, color-mix(in srgb, var(--accent) 70%, transparent), var(--panel));
  border-color: color-mix(in srgb, var(--accent) 70%, transparent);
  color: #0b0b0b;
  text-shadow: 0 1px 0 rgba(0, 0, 0, 0.15);
}

.ghost-button {
  background: transparent;
  color: var(--ink);
  border-style: dashed;
}

.icon-button {
  width: 40px;
  height: 40px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  border: 1px solid var(--border);
  background: var(--panel);
  color: var(--ink);
  transition: all 0.2s ease;
  will-change: transform;
}

.icon-button:hover {
  border-color: var(--accent);
  color: var(--accent);
  transform: translate3d(0, -2px, 0);
}

.accent-hover:hover {
  background: color-mix(in srgb, var(--panel) 60%, var(--accent));
}

.border,
.border-b,
.border-t,
.border-r,
.border-l {
  border-color: var(--border) !important;
}

.contrast-active {
  background: var(--ink);
  color: #0b0b0b !important;
  border-color: var(--ink);
  box-shadow: 0 0 0 1px var(--ink);
}

.contrast-active svg {
  color: #0b0b0b;
}

.pill,
.badge {
  border: 1px solid var(--border);
  padding: 0.3rem 0.6rem;
  font-size: 0.72rem;
  border-radius: 999px;
  background: var(--panel);
  text-transform: uppercase;
  letter-spacing: 0.08em;
  display: inline-flex;
  align-items: center;
  gap: 0.35rem;
}

.badge-orange {
  background: rgba(255, 85, 0, 0.14);
  color: var(--accent);
  border-color: rgba(255, 85, 0, 0.45);
  box-shadow: 0 6px 14px rgba(255, 85, 0, 0.18);
}

.badge-outline {
  background: transparent;
  border-style: dashed;
  color: var(--accent);
}

.muted {
  color: var(--muted);
}

.alert-text {
  color: var(--accent);
}

.divide-swiss > :not([hidden]) ~ :not([hidden]) {
  border-top: 1px solid var(--border);
}

.tile {
  border: 1px solid var(--border);
  padding: 1rem;
  background: var(--panel);
  display: grid;
  gap: 0.5rem;
  border-radius: calc(var(--radius) - 8px);
  box-shadow: 0 14px 45px rgba(0, 0, 0, 0.5);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
}

.tile strong {
  font-size: 0.95rem;
  letter-spacing: 0.12em;
  text-transform: uppercase;
}

.tile .value {
  font-size: 1.6rem;
  font-weight: 800;
}

.glass-panel,
.main {
  background: linear-gradient(180deg, rgba(255, 255, 255, 0.03), rgba(255, 255, 255, 0.02));
  border: 1px solid var(--border);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  padding: 1.25rem;
  display: flex;
  flex-direction: column;
  gap: 1rem;
  backdrop-filter: blur(12px) saturate(1.05);
  -webkit-backdrop-filter: blur(12px) saturate(1.05);
}

.top-nav {
  display: flex;
  align-items: center;
  justify-content: space-between;
  border-bottom: 1px solid var(--border);
  padding-bottom: 0.75rem;
}

.logo-mark {
  display: flex;
  align-items: center;
  gap: 0.75rem;
}

.logo-ring {
  width: 40px;
  height: 40px;
  border-radius: 12px;
  display: grid;
  place-items: center;
  border: 1px solid var(--border);
  background: radial-gradient(circle at 30% 30%, rgba(255, 85, 0, 0.25), rgba(255, 255, 255, 0.02));
}

.logo-text {
  display: grid;
  gap: 0.1rem;
  text-transform: uppercase;
  letter-spacing: 0.12em;
  font-weight: 800;
}

.nav-actions {
  display: flex;
  align-items: center;
  gap: 0.75rem;
}

.user-chip {
  display: flex;
  align-items: center;
  gap: 0.55rem;
  padding: 0.45rem 0.75rem;
  border: 1px solid var(--border);
  border-radius: 12px;
  background: var(--panel);
}

.user-chip .avatar {
  width: 34px;
  height: 34px;
  border-radius: 10px;
  background: rgba(255, 255, 255, 0.08);
  display: grid;
  place-items: center;
  font-weight: 800;
}

.user-chip .names {
  display: grid;
  gap: 0.1rem;
  line-height: 1.2;
}

.library-search {
  display: grid;
  gap: 0.35rem;
}

.library-search .hint {
  font-size: 0.7rem;
}

.swiss-shell .flex-1 > .p-6,
.swiss-shell .flex-1 > .border-b,
.swiss-shell .flex-1 > .tile,
.swiss-shell .flex-1 > section,
.swiss-shell .flex-1 > header {
  gap: var(--grid-gap);
}

.trash-zone {
  margin-top: auto;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
  padding: 0.9rem 1rem;
  border-radius: calc(var(--radius) - 8px);
  border: 1px dashed var(--border);
  color: var(--muted);
  text-transform: uppercase;
  letter-spacing: 0.08em;
  background: rgba(255, 255, 255, 0.02);
  transition: all 0.2s ease;
  will-change: transform;
}

.trash-zone.is-hovered {
  border-color: var(--accent);
  color: var(--accent);
  background: rgba(255, 85, 0, 0.08);
  box-shadow: 0 12px 30px rgba(255, 85, 0, 0.28);
  transform: translate3d(0, -2px, 0);
}

.set-grid {
  display: grid;
  grid-template-columns: repeat(3, minmax(0, 1fr));
  gap: 1rem;
  grid-auto-rows: var(--card-height);
}

.set-card {
  position: relative;
  border: 1px solid var(--border);
  border-radius: calc(var(--radius) - 6px);
  background: radial-gradient(circle at 20% 20%, rgba(255, 85, 0, 0.1), transparent 40%),
              var(--panel);
  overflow: hidden;
  display: grid;
  grid-template-rows: 1fr auto auto;
  padding: 1rem;
  gap: 0.75rem;
  box-shadow: 0 18px 50px rgba(0, 0, 0, 0.6);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  transition: transform 0.24s ease, box-shadow 0.24s ease, border-color 0.2s ease, background 0.24s ease;
  will-change: transform;
}

.set-card:hover {
  transform: translate3d(0, -6px, 0) scale(1.01);
  border-color: var(--accent);
  box-shadow: 0 24px 70px rgba(0, 0, 0, 0.7), 0 0 0 1px rgba(255, 85, 0, 0.35);
}

.set-card.dragging,
.set-card:active {
  transform: translate3d(0, -2px, 0) scale(0.995);
  opacity: 0.95;
  border-color: rgba(255, 85, 0, 0.5);
}

.set-thumb {
  border-radius: calc(var(--radius) - 8px);
  background: linear-gradient(145deg, rgba(255, 255, 255, 0.05), rgba(255, 255, 255, 0.01));
  border: 1px solid var(--border);
  display: grid;
  place-items: center;
  color: var(--muted);
  font-weight: 800;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  min-height: 120px;
  background-size: cover;
  background-position: center;
  overflow: hidden;
}

.set-thumb .fallback {
  padding: 0.5rem 0.75rem;
  background: rgba(0, 0, 0, 0.25);
  border-radius: 10px;
  border: 1px solid var(--border);
}

.set-meta {
  display: grid;
  gap: 0.4rem;
}

.set-pill {
  display: inline-flex;
  align-items: center;
  gap: 0.35rem;
  padding: 0.3rem 0.55rem;
  border-radius: 10px;
  border: 1px solid var(--border);
  background: rgba(255, 255, 255, 0.03);
  font-size: 0.78rem;
  letter-spacing: 0.06em;
}

.set-title {
  font-size: 1.05rem;
  font-weight: 800;
  letter-spacing: 0.1em;
  text-transform: uppercase;
}

.set-artist {
  color: var(--muted);
  text-transform: uppercase;
  letter-spacing: 0.08em;
}

.set-footer {
  display: flex;
  align-items: center;
  justify-content: space-between;
  font-size: 0.78rem;
  color: var(--muted);
}

.stat-row {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 0.75rem;
}

.stat {
  border: 1px solid var(--border);
  border-radius: calc(var(--radius) - 8px);
  padding: 0.85rem 1rem;
  background: var(--panel);
  box-shadow: 0 12px 30px rgba(0, 0, 0, 0.45);
}

.stat .label {
  color: var(--muted);
  text-transform: uppercase;
  letter-spacing: 0.1em;
}

.stat .value {
  font-size: 1.2rem;
  font-weight: 800;
}

.track-panel {
  border: 1px solid var(--border);
  border-radius: var(--radius);
  background: var(--panel);
  box-shadow: var(--shadow);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  overflow: hidden;
}

.track-panel-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 1rem 1.25rem;
  border-bottom: 1px solid var(--border);
}

.tracklist {
  display: grid;
  gap: 0.5rem;
  padding: 1rem 1.25rem;
}

.track {
  display: grid;
  grid-template-columns: 70px 1fr 120px 120px 140px;
  align-items: center;
  gap: 0.75rem;
  padding: 0.75rem 0.85rem;
  border: 1px solid var(--border);
  border-radius: 12px;
  background: rgba(255, 255, 255, 0.03);
  transition: transform 0.2s ease, border-color 0.2s ease, box-shadow 0.25s ease;
  will-change: transform;
}

.track:hover {
  border-color: var(--accent);
  transform: translate3d(0, -2px, 0);
  box-shadow: 0 16px 34px rgba(0, 0, 0, 0.45);
}

.track .pos {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-weight: 800;
  letter-spacing: 0.06em;
}

.track .names {
  display: grid;
  gap: 0.2rem;
}

.track .song {
  font-weight: 700;
  letter-spacing: 0.05em;
}

.track .artist {
  color: var(--muted);
  font-size: 0.85rem;
  letter-spacing: 0.08em;
}

.track .controls {
  display: inline-flex;
  justify-content: flex-end;
  gap: 0.35rem;
}

.player-bar {
  position: sticky;
  bottom: 0;
  left: 0;
  right: 0;
  padding: 0.85rem 1rem;
  border-top: 1px solid var(--border);
  background: linear-gradient(180deg, rgba(0, 0, 0, 0), rgba(0, 0, 0, 0.65)),
              rgba(10, 10, 10, 0.85);
  backdrop-filter: blur(12px) saturate(1.05);
  -webkit-backdrop-filter: blur(12px) saturate(1.05);
  display: flex;
  align-items: center;
  gap: 0.75rem;
  z-index: 50;
  box-shadow: 0 -12px 38px rgba(0, 0, 0, 0.55);
}

.player-bar .meta {
  display: grid;
  gap: 0.1rem;
}

.player-bar .actions {
  margin-left: auto;
  display: inline-flex;
  gap: 0.5rem;
}

.progress {
  --progress: 0%;
  position: relative;
  width: 100%;
  height: 8px;
  border-radius: 999px;
  background: rgba(255, 255, 255, 0.08);
  border: 1px solid var(--border);
  overflow: hidden;
}

.progress::after {
  content: '';
  position: absolute;
  inset: 0;
  width: var(--progress);
  background: linear-gradient(90deg, var(--accent), var(--accent-strong));
  box-shadow: 0 0 0 1px rgba(255, 85, 0, 0.28);
  transition: width 0.2s ease;
}

.progress-sm {
  height: 6px;
}

.progress-lg {
  height: 12px;
}

.badge-soft {
  background: rgba(255, 85, 0, 0.08);
  border-color: rgba(255, 85, 0, 0.3);
  color: var(--accent);
}

.toast-stack {
  position: fixed;
  right: 18px;
  bottom: 18px;
  display: grid;
  gap: 0.5rem;
  z-index: 80;
}

.toast {
  padding: 12px 14px;
  border-radius: 14px;
  border: 1px solid var(--border);
  background: rgba(0, 0, 0, 0.7);
  letter-spacing: 0.06em;
  color: var(--ink);
  box-shadow: 0 18px 40px rgba(0, 0, 0, 0.5);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
}

.toast .subtitle {
  font-size: 12px;
  color: var(--muted);
}

.modal-backdrop {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.65);
  display: grid;
  place-items: center;
  z-index: 70;
}

.modal {
  width: min(720px, 90vw);
  background: rgba(12, 12, 12, 0.9);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 1.25rem;
  box-shadow: var(--shadow);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  display: grid;
  gap: 0.9rem;
}

.modal-grid {
  display: grid;
  gap: 0.75rem;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
}

.modal-actions {
  display: flex;
  justify-content: flex-end;
  gap: 0.5rem;
}

.context-menu,
[x-ref="contextMenu"] {
  border: 1px solid var(--border);
  background: rgba(12, 12, 12, 0.95);
  box-shadow: var(--shadow);
  border-radius: calc(var(--radius) - 8px);
  overflow: hidden;
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
}

@media (max-width: 1200px) {
  .swiss-shell {
    grid-template-columns: 1fr;
  }

  .swiss-sidebar {
    position: relative;
    min-height: auto;
    width: 100%;
  }

  .set-grid {
    grid-template-columns: repeat(2, minmax(0, 1fr));
  }
}

@media (max-width: 800px) {
  .swiss-shell {
    padding: 1rem;
    gap: 1rem;
  }

  .top-nav {
    flex-direction: column;
    align-items: flex-start;
    gap: 0.75rem;
  }

  .set-grid {
    grid-template-columns: 1fr;
    grid-auto-rows: minmax(var(--card-height), auto);
  }

  .track {
    grid-template-columns: 1fr;
  }
}

@media (prefers-reduced-motion: reduce) {
  *, *::before, *::after {
    transition: none !important;
    animation-duration: 0.01ms !important;
  }
}

/* ==========================================================================
   Application Layout
   ========================================================================== */
.glass-panel {
  background: linear-gradient(180deg, color-mix(in srgb, var(--panel) 80%, black 5%), var(--panel-strong));
  border: 1px solid var(--border);
  border-radius: var(--radius);
  backdrop-filter: blur(14px);
  box-shadow: var(--shadow);
}

.app-body {
  min-height: 100vh;
  display: flex;
  flex-direction: column;
}

.app-shell {
  display: grid;
  grid-template-columns: 260px 1fr;
  gap: 1.5rem;
  padding: 1.5rem;
  align-items: start;
}

.sidebar {
  position: sticky;
  top: 1.5rem;
  height: calc(100vh - 3rem);
  display: flex;
  flex-direction: column;
  gap: 1rem;
  padding: 1.25rem;
}

.sidebar-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 0.75rem;
}

.brand {
  display: grid;
  gap: 0.1rem;
  text-transform: uppercase;
  letter-spacing: 0.12em;
}

.brand-eyebrow {
  color: var(--muted);
  font-size: 0.75rem;
}

.brand-title {
  font-weight: 800;
  font-size: 1rem;
}

.sidebar-section {
  display: grid;
  gap: 0.6rem;
}

.label {
  font-size: 0.75rem;
  text-transform: uppercase;
  letter-spacing: 0.12em;
  color: var(--muted);
  font-weight: 700;
}

.input-field {
  width: 100%;
  padding: 0.75rem 0.85rem;
  border-radius: calc(var(--radius) - 6px);
  border: 1px solid var(--border);
  background: var(--panel);
  color: var(--ink);
  font-weight: 700;
  letter-spacing: 0.04em;
}

.input-field:focus-visible {
  outline: 1px solid var(--accent);
  border-color: var(--accent);
}

.hint {
  font-size: 0.78rem;
  color: var(--muted);
  letter-spacing: 0.08em;
}

.section-heading {
  display: flex;
  align-items: center;
  justify-content: space-between;
  text-transform: uppercase;
  letter-spacing: 0.12em;
  font-weight: 800;
  font-size: 0.85rem;
}

.folder-list,
.set-list {
  display: grid;
  gap: 0.5rem;
}

.folder-card,
.set-list-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 0.5rem;
  padding: 0.75rem 0.85rem;
  border: 1px solid var(--border);
  border-radius: calc(var(--radius) - 8px);
  background: var(--panel);
  transition: border-color 0.2s ease, transform 0.18s ease, background 0.2s ease;
}

.folder-card:hover,
.set-list-item:hover {
  border-color: var(--accent);
}

.set-list-item.is-active {
  border-color: var(--accent);
  background: color-mix(in srgb, var(--panel) 60%, var(--accent) 35%);
  color: #0b0b0b;
}

.folder-card.is-hovered,
.trash-zone.is-hovered {
  border-color: var(--accent);
  background: color-mix(in srgb, var(--panel) 60%, var(--accent) 30%);
  color: var(--ink);
}

.folder-meta,
.set-list-titles {
  display: grid;
  gap: 0.15rem;
  min-width: 0;
}

.set-list-name {
  font-weight: 800;
  letter-spacing: 0.04em;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.chip-button {
  border: 1px solid var(--border);
  background: var(--panel);
  color: var(--ink);
  font-weight: 800;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  padding: 0.45rem 0.85rem;
  border-radius: 999px;
  transition: border-color 0.2s ease, color 0.2s ease, background 0.2s ease, transform 0.18s ease;
}

.chip-button.is-active,
.chip-button:hover {
  border-color: var(--accent);
  color: #0b0b0b;
  background: color-mix(in srgb, var(--panel) 60%, var(--accent) 40%);
  transform: translateY(-1px);
}

.icon-button {
  width: 2.5rem;
  height: 2.5rem;
  border-radius: 50%;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  border: 1px solid var(--border);
  background: var(--panel);
  color: var(--ink);
  transition: border-color 0.2s ease, transform 0.18s ease, color 0.2s ease;
}

.icon-button.compact {
  width: 2.25rem;
  height: 2.25rem;
  border-radius: calc(var(--radius) - 8px);
}

.icon-button:hover {
  border-color: var(--accent);
  color: var(--accent);
  transform: translateY(-1px);
}

.trash-zone {
  margin-top: auto;
  padding: 0.9rem;
  border: 1px dashed var(--border);
  border-radius: calc(var(--radius) - 6px);
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
  text-transform: uppercase;
  letter-spacing: 0.14em;
  color: var(--muted);
  background: var(--panel);
}

.empty-hint {
  color: var(--muted);
  font-size: 0.8rem;
  letter-spacing: 0.08em;
}

.main-content {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.topbar {
  padding: 1rem 1.25rem;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 1rem;
}

.topbar-left {
  display: flex;
  align-items: center;
  gap: 1rem;
  flex-wrap: wrap;
}

.view-switcher {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
}

.topbar-actions {
  display: flex;
  align-items: center;
  gap: 0.75rem;
}

.logo-mark {
  display: inline-flex;
  align-items: center;
  gap: 0.6rem;
}

.logo-ring {
  width: 2.75rem;
  height: 2.75rem;
  border-radius: calc(var(--radius) - 6px);
  border: 1px solid var(--border);
  display: inline-flex;
  align-items: center;
  justify-content: center;
  background: linear-gradient(135deg, rgba(255, 85, 0, 0.18), rgba(255, 255, 255, 0.08));
}

.logo-text {
  display: grid;
  line-height: 1.1;
  letter-spacing: 0.08em;
  font-weight: 800;
  text-transform: uppercase;
}

.user-chip {
  display: flex;
  align-items: center;
  gap: 0.6rem;
  padding: 0.45rem 0.75rem;
  border-radius: calc(var(--radius) - 8px);
  border: 1px solid var(--border);
  background: var(--panel);
}

.avatar {
  width: 2.4rem;
  height: 2.4rem;
  border-radius: 50%;
  background: linear-gradient(135deg, rgba(255, 85, 0, 0.24), rgba(255, 255, 255, 0.12));
  display: inline-flex;
  align-items: center;
  justify-content: center;
  font-weight: 800;
  border: 1px solid var(--border);
}

.user-name {
  font-weight: 800;
}

.user-meta {
  font-size: 0.75rem;
  letter-spacing: 0.08em;
  color: var(--muted);
}

.panel {
  padding: 1.25rem;
  border: 1px solid var(--border);
  border-radius: var(--radius);
  background: var(--panel);
  display: grid;
  gap: 1rem;
}

.panel-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 0.75rem;
}

.panel-actions {
  display: flex;
  gap: 0.5rem;
}

.queue-state {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
  gap: 0.75rem;
}

.queue-state .value {
  font-weight: 800;
  font-size: 1.2rem;
}

.stat-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
  gap: 0.75rem;
}

.stat-card {
  padding: 1rem;
  border-radius: calc(var(--radius) - 6px);
  border: 1px solid var(--border);
  background: var(--panel);
  display: grid;
  gap: 0.4rem;
}

.stat-value {
  font-size: 1.8rem;
  font-weight: 800;
}

.set-grid {
  display: grid;
  grid-template-columns: repeat(3, minmax(0, 1fr));
  gap: 1rem;
}

.set-card {
  position: relative;
  overflow: hidden;
  border-radius: var(--radius);
  border: 1px solid var(--border);
  background: linear-gradient(170deg, rgba(255, 255, 255, 0.06), rgba(0, 0, 0, 0.45));
  display: grid;
  grid-template-rows: 160px 1fr;
  min-height: 280px;
  cursor: pointer;
  transition: transform 0.2s ease, border-color 0.2s ease, background 0.2s ease;
}

.set-card:hover {
  transform: translateY(-2px);
  border-color: var(--accent);
}

.set-thumb {
  background-size: cover;
  background-position: center;
  position: relative;
}

.set-thumb::after {
  content: '';
  position: absolute;
  inset: 0;
  background: linear-gradient(180deg, transparent 30%, rgba(0, 0, 0, 0.55));
}

.set-thumb-fallback {
  position: absolute;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 800;
  letter-spacing: 0.12em;
  color: rgba(255, 255, 255, 0.7);
  background: linear-gradient(135deg, rgba(255, 85, 0, 0.22), rgba(255, 255, 255, 0.14));
}

.set-meta {
  padding: 0.85rem 1rem 1rem;
  display: grid;
  gap: 0.5rem;
}

.set-pill {
  display: inline-flex;
  align-items: center;
  gap: 0.4rem;
  padding: 0.4rem 0.7rem;
  border-radius: 999px;
  background: var(--panel-strong);
  font-size: 0.8rem;
  letter-spacing: 0.08em;
}

.set-title {
  font-weight: 800;
  letter-spacing: 0.06em;
}

.set-artist {
  color: var(--muted);
  font-size: 0.9rem;
}

.set-footer {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 1rem 1rem;
  font-size: 0.85rem;
  color: var(--muted);
}

.empty-card {
  border: 1px dashed var(--border);
  border-radius: var(--radius);
  padding: 1.5rem;
  text-align: center;
  color: var(--muted);
  grid-column: 1 / -1;
}

.track-panel {
  padding: 1rem;
  border-radius: var(--radius);
  border: 1px solid var(--border);
  background: var(--panel);
  display: grid;
  gap: 0.75rem;
}

.tracklist {
  display: grid;
  gap: 0.75rem;
}

.track-row {
  display: grid;
  grid-template-columns: 120px 1.2fr 0.8fr 0.8fr 1fr;
  align-items: center;
  gap: 0.75rem;
  padding: 0.85rem;
  border-radius: calc(var(--radius) - 6px);
  border: 1px solid var(--border);
  background: var(--panel-strong);
}

.track-position {
  display: inline-flex;
  align-items: center;
  gap: 0.6rem;
  font-weight: 800;
  letter-spacing: 0.08em;
}

.track-names {
  display: grid;
  gap: 0.2rem;
  min-width: 0;
}

.track-title {
  font-weight: 700;
}

.track-artist {
  color: var(--muted);
  font-size: 0.9rem;
}

.track-meta {
  display: grid;
  gap: 0.15rem;
  font-size: 0.9rem;
}

.track-controls {
  display: flex;
  gap: 0.5rem;
  justify-content: flex-end;
  flex-wrap: wrap;
}

.ghost-button {
  border: 1px solid var(--border);
  background: var(--panel);
  color: var(--ink);
  font-weight: 800;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  padding: 0.6rem 0.9rem;
  border-radius: calc(var(--radius) - 8px);
  cursor: pointer;
  transition: border-color 0.2s ease, color 0.2s ease, background 0.2s ease, transform 0.18s ease;
}

.ghost-button:hover {
  border-color: var(--accent);
  color: #0b0b0b;
  background: color-mix(in srgb, var(--panel) 60%, var(--accent) 40%);
  transform: translateY(-1px);
}

.pill-link {
  background: transparent;
  color: var(--muted);
  border-color: transparent;
}

.cta {
  background: linear-gradient(135deg, var(--accent), color-mix(in srgb, var(--accent) 70%, white 20%));
  border: none;
  color: #0b0b0b;
  font-weight: 800;
  padding: 0.75rem 1.1rem;
  border-radius: calc(var(--radius) - 8px);
  letter-spacing: 0.12em;
  text-transform: uppercase;
  box-shadow: 0 16px 40px rgba(255, 85, 0, 0.35);
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.cta:hover {
  transform: translateY(-1px);
  box-shadow: 0 22px 48px rgba(255, 85, 0, 0.45);
}

.toast-stack {
  position: fixed;
  bottom: 1.5rem;
  right: 1.5rem;
  z-index: 900;
  display: grid;
  gap: 0.75rem;
}

.toast {
  padding: 0.85rem 1rem;
  border-radius: calc(var(--radius) - 6px);
  border: 1px solid var(--border);
  background: var(--panel-strong);
  letter-spacing: 0.06em;
}

.toast-title {
  font-weight: 800;
}

.toast-subtitle {
  font-size: 0.85rem;
  color: var(--muted);
}

.modal-backdrop {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.65);
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 1rem;
  z-index: 800;
}

.modal {
  width: 100%;
  max-width: 720px;
  padding: 1.25rem;
  display: grid;
  gap: 1rem;
}

.modal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.modal-tabs {
  display: inline-flex;
  align-items: center;
  gap: 0.25rem;
}

.tab {
  border: 1px solid var(--border);
  background: var(--panel);
  color: var(--ink);
  padding: 0.55rem 0.9rem;
  border-radius: calc(var(--radius) - 10px);
  font-weight: 800;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  cursor: pointer;
}

.tab.is-active {
  border-color: var(--accent);
  color: #0b0b0b;
  background: color-mix(in srgb, var(--panel) 60%, var(--accent) 40%);
}

.modal-content {
  display: grid;
  gap: 0.75rem;
}

.modal-field {
  display: grid;
  gap: 0.35rem;
}

.modal-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 0.75rem;
}

.modal-row {
  display: grid;
  gap: 0.35rem;
}

.modal-row.inline {
  align-items: center;
  grid-template-columns: auto auto;
  justify-content: space-between;
}

.input-row {
  display: flex;
  gap: 0.5rem;
}

.modal-actions {
  display: flex;
  justify-content: flex-end;
  gap: 0.5rem;
}

.checkbox {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  letter-spacing: 0.08em;
}

.context-menu {
  position: fixed;
  z-index: 950;
  min-width: 240px;
  padding: 0.5rem;
}

.context-menu-header {
  font-size: 0.75rem;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  color: var(--muted);
  padding: 0.25rem 0.5rem;
}

.context-menu-body {
  display: grid;
  gap: 0.25rem;
}

.context-menu-subtitle {
  font-size: 0.75rem;
  letter-spacing: 0.08em;
  color: var(--muted);
  padding: 0.25rem 0.5rem;
}

.context-menu-item {
  width: 100%;
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.55rem 0.65rem;
  border-radius: calc(var(--radius) - 10px);
  border: 1px solid transparent;
  background: transparent;
  color: var(--ink);
  cursor: pointer;
}

.context-menu-item:hover {
  background: var(--panel-strong);
  border-color: var(--border);
}

.context-menu-item.danger {
  color: #f87171;
}

.menu-icon {
  width: 1rem;
  height: 1rem;
}

.player-bar {
  position: sticky;
  bottom: 0;
  width: calc(100% - 3rem);
  margin: 1rem auto;
  padding: 0.85rem 1.25rem;
  border: 1px solid var(--border);
  border-radius: var(--radius);
  display: grid;
  grid-template-columns: auto 1fr;
  gap: 1rem;
  align-items: center;
  z-index: 1000;
}

.player-meta {
  display: inline-flex;
  align-items: center;
  gap: 0.75rem;
}

.player-text {
  display: grid;
  gap: 0.15rem;
}

.player-title {
  font-weight: 800;
}

.player-artist {
  color: var(--muted);
  font-size: 0.9rem;
}

.player-progress {
  display: grid;
  gap: 0.25rem;
  cursor: pointer;
}

.progress-bar {
  width: 100%;
  height: 8px;
  background: var(--border);
  border-radius: 999px;
  overflow: hidden;
}

.progress-fill {
  height: 100%;
  background: var(--accent);
  width: 0;
  transition: width 0.1s linear;
}

.progress-times {
  display: flex;
  align-items: center;
  justify-content: space-between;
  font-size: 0.85rem;
  color: var(--muted);
}

.truncate {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

@media (max-width: 1200px) {
  .app-shell {
    grid-template-columns: 1fr;
  }

  .sidebar {
    position: static;
    height: auto;
  }

  .set-grid {
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  }

  .track-row {
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
  }

  .player-bar {
    width: calc(100% - 2rem);
  }
}

@media (max-width: 640px) {
  .topbar,
  .panel-header {
    flex-direction: column;
    align-items: flex-start;
  }

  .player-bar {
    grid-template-columns: 1fr;
  }
}


================================================
DATEI: static/js/app.js
================================================
class AudioController {
    constructor(ctx) {
        this.ctx = ctx;
        this.progressEl = null;
        this.dragging = false;
        this.boundMove = (e) => this.handleSeekMove(e);
        this.boundEnd = (e) => this.stopSeek(e);
    }

    get player() {
        return this.ctx?.$refs?.player || null;
    }

    syncVolume() {
        if (this.player) this.player.volume = this.ctx.audio.volume;
    }

    registerProgressEl(el) {
        if (el) this.progressEl = el;
    }

    async playTrack(target) {
        const track = typeof target === 'object' ? target : null;
        const query = typeof target === 'string'
            ? target
            : (track?.streamUrl || track?.audio_file || track?.source_url || `${track?.artist || ''} ${track?.title || ''}`.trim());

        if (!query) {
            this.ctx.showToast('Keine Quelle', 'Track enth√§lt keinen Stream.', 'error');
            return;
        }

        this.ctx.activeTrack = track || this.ctx.activeTrack;
        this.ctx.ui.loadingId = track?.id || null;
        this.ctx.audio.currentTime = 0;
        this.ctx.audio.progressPercent = 0;

        try {
            const url = await this.resolveUrl(query, track);
            await this.startPlayback(url, track);
            const label = track ? `${track.artist || 'Unknown'} - ${track.title || ''}` : 'Stream gestartet';
            this.ctx.showToast('Play', label.trim(), 'info');
        } catch (error) {
            this.ctx.ui.playingId = null;
            this.ctx.showToast('Playback Fehler', error?.message || 'Konnte Stream nicht laden.', 'error');
            throw error;
        } finally {
            this.ctx.ui.loadingId = null;
        }
    }

    async resolveUrl(query, track) {
        if (track?.streamUrl) return track.streamUrl;

        const res = await fetch('/api/resolve_audio', {
            method: 'POST',
            body: JSON.stringify({ query })
        });
        const data = await res.json();

        if (!res.ok || !data.ok || !data.url) {
            const message = data.error || 'Keine Quelle gefunden.';
            throw new Error(message);
        }

        if (track) track.streamUrl = data.url;
        return data.url;
    }

    async startPlayback(url, track) {
        const player = this.player;
        if (!player) return;

        player.src = url;
        this.syncVolume();

        try {
            await player.play();
            this.ctx.ui.playingId = track?.id || this.ctx.ui.playingId;
            this.ctx.audio.paused = false;
        } catch (error) {
            this.ctx.audio.paused = true;
            throw error;
        }
    }

    async toggle(track) {
        const player = this.player;
        if (!player) return;

        if (this.ctx.ui.playingId === track?.id && this.ctx.activeTrack) {
            if (player.paused) { await player.play(); this.ctx.audio.paused = false; }
            else { player.pause(); this.ctx.audio.paused = true; }
            return;
        }

        return this.playTrack(track);
    }

    handleTimeUpdate(event) {
        if (this.dragging) return;
        const { currentTime, duration, paused } = event.target;
        this.ctx.audio.currentTime = currentTime;
        this.ctx.audio.duration = duration;
        this.ctx.audio.progressPercent = duration ? (currentTime / duration) * 100 : 0;
        this.ctx.audio.paused = paused;
    }

    seekFromEvent(event, element = null) {
        const player = this.player;
        const target = element || this.progressEl || event?.currentTarget;
        if (!player || !target || !player.duration) return;

        const rect = target.getBoundingClientRect();
        const pct = Math.max(0, Math.min(1, (event.clientX - rect.left) / rect.width));
        const nextTime = pct * player.duration;

        this.ctx.audio.progressPercent = pct * 100;
        this.ctx.audio.currentTime = nextTime;
        player.currentTime = nextTime;
    }

    startSeek(event) {
        this.progressEl = event?.currentTarget || this.progressEl;
        if (!this.player?.duration || !this.progressEl) return;

        this.dragging = true;
        this.seekFromEvent(event, this.progressEl);
        window.addEventListener('pointermove', this.boundMove);
        window.addEventListener('pointerup', this.boundEnd);
    }

    handleSeekMove(event) {
        if (!this.dragging) return;
        this.seekFromEvent(event, this.progressEl);
    }

    stopSeek(event) {
        if (!this.dragging) return;
        this.seekFromEvent(event, this.progressEl);
        this.dragging = false;
        window.removeEventListener('pointermove', this.boundMove);
        window.removeEventListener('pointerup', this.boundEnd);
    }

    handleEnded() {
        this.ctx.audio.paused = true;
        this.ctx.audio.progressPercent = 0;
        const advanced = this.next();
        if (!advanced) this.ctx.ui.playingId = null;
    }

    handleError() {
        this.ctx.ui.playingId = null;
        this.ctx.ui.loadingId = null;
        this.ctx.audio.paused = true;
        this.ctx.showToast('Playback Fehler', 'Audio konnte nicht geladen werden.', 'error');
    }

    next() {
        const queue = Array.isArray(this.ctx.tracks) ? this.ctx.tracks : [];
        if (!queue.length) return false;

        const currentId = this.ctx.ui.playingId || this.ctx.activeTrack?.id;
        const currentIndex = queue.findIndex(t => t.id === currentId);
        if (currentIndex === -1) return false;
        const nextIndex = currentIndex + 1;

        if (nextIndex >= 0 && nextIndex < queue.length) {
            this.playTrack(queue[nextIndex]);
            return true;
        }

        this.ctx.ui.playingId = null;
        this.ctx.audio.progressPercent = 0;
        return false;
    }

    previous() {
        const queue = Array.isArray(this.ctx.tracks) ? this.ctx.tracks : [];
        if (!queue.length) return false;

        const currentId = this.ctx.ui.playingId || this.ctx.activeTrack?.id;
        const currentIndex = queue.findIndex(t => t.id === currentId);
        if (currentIndex === -1) return false;

        if (currentIndex > 0) {
            this.playTrack(queue[currentIndex - 1]);
            return true;
        }

        if (this.player && this.player.currentTime > 2) {
            this.player.currentTime = 0;
            return true;
        }

        return false;
class UploadManager {
    constructor(component) {
        this.component = component;
        this.debounceTimer = null;
    }

    setTab(tab) {
        this.component.uploadState.tab = tab;
        this.component.inputs.url = tab === 'url' ? this.component.inputs.url : '';
        if (tab === 'url') {
            this.resetFile();
        } else {
            this.component.inputs.metaName = '';
            this.component.inputs.metaArtist = '';
            this.component.inputs.metaEvent = '';
            this.component.inputs.metaTags = '';
        }
    }

    resetFile() {
        this.component.inputs.file = null;
        if (this.component.$refs.fileInput) {
            this.component.$refs.fileInput.value = '';
        }
    }

    handleUrlInput(value) {
        const url = (value || '').trim();
        this.component.inputs.url = url;
        this.component.uploadState.tab = 'url';
        this.triggerMetadataResolve(url);
    }

    handlePaste(event) {
        const pasted = event.clipboardData?.getData('text') || '';
        if (pasted) {
            this.handleUrlInput(pasted);
        }
    }

    triggerMetadataResolve(url) {
        clearTimeout(this.debounceTimer);
        if (!url) return;
        this.debounceTimer = setTimeout(() => {
            this.component.fetchUrlMetadata(url);
        }, 350);
    }

    handleFileChange(file) {
        this.component.uploadState.tab = 'file';
        this.component.inputs.file = file || null;
        this.component.parseFileMetadata(file);
    }

    async submit(typeOverride = null) {
        if (!this.component.ensureAuthenticated()) return;

        const type = typeOverride || this.component.uploadState.tab;
        const metadata = {
            name: this.component.inputs.metaName,
            artist: this.component.inputs.metaArtist,
            event: this.component.inputs.metaEvent,
            tags: this.component.inputs.metaTags,
            is_b2b: this.component.inputs.is_b2b
        };

        this.component.uploadState.isSubmitting = true;
        try {
            if (type === 'url') {
                if (!this.component.inputs.url) return;
                const res = await fetch('/api/queue/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        type: 'url',
                        value: this.component.inputs.url,
                        metadata
                    })
                });
                if (res.status === 401) return this.component.ensureAuthenticated();
            } else {
                const file = this.component.inputs.file || (this.component.$refs.fileInput?.files || [])[0];
                if (!file) return;
                const fd = new FormData();
                fd.append('type', 'file');
                fd.append('file', file);
                fd.append('metadata', JSON.stringify(metadata));
                const res = await fetch('/api/queue/add', { method: 'POST', body: fd });
                if (res.status === 401) return this.component.ensureAuthenticated();
            }

            this.component.ui.showAddModal = false;
            this.component.showQueueView();
            this.component.resetUploadInputs();
            await this.component.pollQueue();
        } finally {
            this.component.uploadState.isSubmitting = false;
        }
    }
}

document.addEventListener('alpine:init', () => {
    Alpine.data('tracklistify', () => ({
        // =====================================================================
        // DATA STORAGE
        // =====================================================================
        sets: [], 
        filteredSets: [], 
        folders: [],
        search: '',
        activeSet: null, 
        tracks: [],
        likedTracks: [],
        purchasedTracks: [],
        favoriteProducers: [],
        rescanCandidates: [],
        youtubeFeed: [],
        folders: [],
        activeFolderId: null,
        draggingSet: null,
        folderHoverId: null,
        trashHover: false,
        cardHoverId: null,

        auth: {
            user: null,
            form: { email: '', password: '', name: '' },
            mode: 'login',
            error: '',
            dropdownOpen: false
        },
        
        dashboardStats: {
            total_sets: 0,
            total_tracks: 0,
            total_likes: 0,
            discovery_rate: 0,
            top_liked_artists: [],
            top_artists: [],
            top_sets: [],
            recent_sets: [],
            top_producers: [],
            top_djs: []
        },

        profile: { display_name: '', dj_name: '', soundcloud_url: '', avatar_url: '' },

        admin: {
            show: false,
            users: [],
            invite: { username: '', password: '', generated: '' }
        },
        
        // =====================================================================
        // UI STATE
        // =====================================================================
        currentView: 'dashboard',
        queueStatus: { active: null, queue: [], history: [], queue_count: 0 },
        uploadManager: null,
        uploadState: { tab: 'url', lastResolvedUrl: '', isSubmitting: false, isProcessing: false },
        
        // Inputs f√ºr Upload Modal
        inputs: {
            url: '',
            file: null,
            metaName: '',
            metaArtist: '',
            metaEvent: '',
            metaTags: '',
            is_b2b: false,
            isLoadingMeta: false
        },
        
        // Inputs f√ºr Edit Modal
        editSetData: { id: null, name: '', artists: '', event: '', is_b2b: false, tags: '' },
        
        ui: {
            showAddModal: false, 
            showRescanModal: false, 
            showEditSetModal: false, 
            showLikes: false,
            playingId: null, 
            loadingId: null,
            hoverTrackId: null,
            contextMenu: { show: false, x: 0, y: 0, type: null, target: null, folderTarget: null },
            detailPanel: { show: false, type: null, item: null }
        },
        audioController: null,
        
        toasts: [],
        lastLogLine: '', 

        // =====================================================================
        // PLAYER & PRELOADER STATE
        // =====================================================================
        activeTrack: null,
        audio: { 
            currentTime: 0, 
            duration: 0, 
            progressPercent: 0, 
            volume: 0.5, 
            paused: true 
        },
        
        preloadQueue: [],
        activePreloads: 0,
        maxPreloads: 6,

        // =====================================================================
        // INITIALIZATION
        // =====================================================================
        init() {
            this.uploadManager = new UploadManager(this);
            this.fetchSets();
            this.fetchLikes();
            this.fetchPurchases();
            this.fetchProducerLikes();
            this.fetchRescan();
            this.fetchDashboard();
            this.fetchProfile();
            this.fetchYoutube();
            this.loadFolders();

            this.audioController = new AudioController(this);

            // Volume wiederherstellen
            const vol = localStorage.getItem('tracklistify_volume');
            if (vol !== null) this.audio.volume = parseFloat(vol);

            // Globaler Poll Loop (Status Updates)
            setInterval(() => {
                this.pollQueue();
                // Wenn Rescan View offen ist, √∂fter aktualisieren
                if (this.currentView === 'rescan' || this.ui.showRescanModal) {
                    this.fetchRescan();
                }
            }, 1500);

            // Suche Watcher
            this.$watch('search', val => {
                this.updateFilteredSets();
            });
            
            // Player Init
            this.$nextTick(() => {
                if(this.$refs.player) this.$refs.player.volume = this.audio.volume;
                if (this.audioController) {
                    this.audioController.syncVolume();
                    if (this.$refs.footerProgress) this.audioController.registerProgressEl(this.$refs.footerProgress);
                }
            });
        },

        // =====================================================================
        // METADATA PARSING (Server & Client)
        // =====================================================================
        
        // 1. Server: Holt Infos von YouTube/Mixcloud via yt-dlp
        async fetchUrlMetadata(url) {
            if (!url || !(url.startsWith('http') || url.startsWith('www'))) return;
            this.inputs.isLoadingMeta = true;
            try {
                const res = await fetch('/api/resolve_metadata', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url })
                });
                const data = await res.json();

                if (data.ok) {
                    // Nur √ºberschreiben, wenn Felder leer oder wir sicher sind
                    if (!this.inputs.metaName) this.inputs.metaName = data.name || '';
                    if (!this.inputs.metaArtist) this.inputs.metaArtist = data.artist || '';
                    if (!this.inputs.metaEvent) this.inputs.metaEvent = data.event || '';
                    this.uploadState.lastResolvedUrl = url;

                    this.showToast("Infos gefunden", data.name || "Metadaten geladen", "info");
                } else {
                    this.showToast("Keine Metadaten", data.error || "Konnte Infos nicht laden", "info");
                }
            } catch(e) {
                console.error(e);
                this.showToast("Fehler", "Metadaten konnten nicht geladen werden", "error");
            } finally {
                this.inputs.isLoadingMeta = false;
            }
        },

        // 2. Client: Regex Parser f√ºr lokale Dateinamen
        parseFileMetadata(file = null) {
            const targetFile = file || (this.$refs.fileInput && this.$refs.fileInput.files[0]);
            if (targetFile) {
                const raw = targetFile.name.replace(/\.[^/.]+$/, "");
                let clean = raw.replace(/_/g, ' ').replace(/\(.*?\)/g, '').replace(/\[.*?\]/g, '').trim();
                
                // Muster: Artist - Title @ Event
                const parts = clean.split(/\s+-\s+|\s+@\s+|\s+\|\s+/);
                
                if (parts.length >= 2) {
                    this.inputs.metaArtist = parts[0].trim();
                    this.inputs.metaName = parts[1].trim();
                    if (parts.length >= 3) this.inputs.metaEvent = parts[2].trim();
                } else {
                    this.inputs.metaName = clean;
                }
            }
        },

        // =====================================================================
        // QUEUE & JOBS
        // =====================================================================
        async addToQueue(type) {
            return this.uploadManager.submit(type);
        },

        resetUploadInputs() {
            this.inputs.url = '';
            this.inputs.metaName = '';
            this.inputs.metaArtist = '';
            this.inputs.metaEvent = '';
            this.inputs.metaTags = '';
            this.inputs.is_b2b = false;
            this.uploadState.tab = 'url';
            this.uploadState.lastResolvedUrl = '';
            this.uploadManager.resetFile();
        },

        async pollQueue() {
            try {
                const res = await fetch('/api/queue/status');
                const status = await res.json();

                // Job fertig geworden?
                if (this.queueStatus.active && !status.active) {
                    this.fetchSets(); 
                    this.fetchDashboard();
                    this.showToast("Verarbeitung fertig", "Set wurde importiert.", "success");
                }
                
                // Live Log Toasties
                this.handleLiveLog(status);

                this.queueStatus = {
                    active: status.active || null,
                    queue: status.queue || [],
                    history: status.history || [],
                    queue_count: typeof status.queue_count === 'number' ? status.queue_count : (status.queue || []).length
                };
                this.uploadState.isProcessing = !!(status?.active || (status?.queue || []).length);
            } catch(e) {}
        },

        processingLabel() {
            if (this.queueStatus?.active) return this.queueStatus.active.label || 'Processing';
            if (this.queueStatus?.queue && this.queueStatus.queue.length) {
                return this.queueStatus.queue[0].label || 'Queued';
            }
            return '';
        },

        async stopQueue() {
            try {
                await fetch('/api/queue/stop', { method: 'POST' });
                this.showToast("Verarbeitung gestoppt", "Aktiver Job wird abgebrochen.", "info");
                this.pollQueue();
            } catch(e) {
                console.error(e);
            }
        },

        // =====================================================================
        // NAVIGATION & VIEWS
        // =====================================================================
        showDashboard() { 
            this.currentView = 'dashboard'; 
            this.activeSet = null; 
            this.fetchDashboard(); 
            this.ui.trackViewOnly = false;
        },
        
        showQueueView() { 
            this.currentView = 'queue'; 
            this.activeSet = null; 
            this.ui.showLikes = false; 
            this.ui.trackViewOnly = false;
        },
        
        showRescanView() {
            this.currentView = 'rescan';
            this.activeSet = null;
            this.fetchRescan();
            this.ui.showLikes = false;
            this.ui.trackViewOnly = false;
        },

        showLikesView() {
            this.currentView = 'likes';
            this.ui.showLikes = false;
            this.fetchLikes();
            this.fetchPurchases();
            this.fetchProducerLikes();
            this.ui.trackViewOnly = false;
        },

        showCollections() {
            this.currentView = 'collections';
            this.fetchLikes();
            this.ui.trackViewOnly = false;
        },

        showSetView(set) {
            this.loadSet(set);
        },
        focusOnSet(setOrId) {
            this.ui.trackViewOnly = true;
            this.loadSet(setOrId);
        },
        resetTrackView() {
            this.ui.trackViewOnly = false;
            this.currentView = 'sets';
        },

        // =====================================================================
        // SET MANAGEMENT
        // =====================================================================
        async loadSet(setOrId) {
            const isObject = setOrId && typeof setOrId === 'object';
            const id = isObject ? setOrId.id : setOrId;

            // Ensure we always have the latest sidebar list (e.g. after DB reset)
            if (!this.sets.length) {
                await this.fetchSets();
            }

            if (isObject) {
                this.activeSet = setOrId;

                // Ensure the sidebar list contains the set so the active state can be highlighted
                const existing = this.sets.find(s => s.id === id);
                if (!existing) {
                    this.sets = [setOrId, ...this.sets];
                    this.filteredSets = this.sets;
                }
            } else {
                this.activeSet = this.sets.find(s => s.id === id);

                // If the set is not loaded yet (e.g. opened from dashboard recents), fetch the list first
                if (!this.activeSet) {
                    await this.fetchSets();
                    this.activeSet = this.sets.find(s => s.id === id);
                }
            }

            this.currentView = 'sets';
            this.ui.trackViewOnly = true;

            const res = await fetch(`/api/sets/${id}/tracks`);
            this.tracks = await res.json();
            
            // Turbo anwerfen
            this.startPreloading();
        },

        // Context Menu
        openContextMenu(e, payload = {}) {
            if (e) {
                e.preventDefault();
                e.stopPropagation();
            }

            const { type = null, item = null, folderTarget = null } = payload;

            let x = e ? e.clientX : 0;
            let y = e ? e.clientY : 0;
            if (y > window.innerHeight - 240) y = Math.max(16, y - 200); // Overflow prevent

            this.ui.contextMenu = {
                show: true,
                x,
                y,
                type,
                target: item,
                folderTarget
            };
        },

        openSetContextMenu(e, set) {
            this.openContextMenu(e, { type: 'set', item: set });
        },

        closeContextMenu() {
            this.ui.contextMenu.show = false;
        },

        // Edit Modal
        openEditSetModal() {
            const set = this.ui.contextMenu.target;
            if (!set || this.ui.contextMenu.type !== 'set') return;
            this.closeContextMenu();
            this.editSetData = { 
                id: set.id, 
                name: set.name, 
                artists: set.artists || '', 
                event: set.event || '', 
                is_b2b: !!set.is_b2b, 
                tags: set.tags || '' 
            };
            this.ui.showEditSetModal = true;
        },

        async saveSetMetadata() {
            await fetch(`/api/sets/${this.editSetData.id}/metadata`, { 
                method: 'POST', 
                body: JSON.stringify(this.editSetData) 
            });
            this.fetchSets();
            
            // Update Active Set wenn wir gerade drin sind
            if (this.activeSet && this.activeSet.id === this.editSetData.id) {
                this.activeSet = { ...this.activeSet, ...this.editSetData };
            }
            this.ui.showEditSetModal = false;
            this.showToast("√Ñnderungen gespeichert.", "", "success");
        },

        async rescanSetContext() {
            const set = this.ui.contextMenu.target; 
            if (!set || this.ui.contextMenu.type !== 'set') return;
            this.closeContextMenu(); 
            const val = set.audio_file || set.source_url; 
            
            if(!val) return alert("Keine Audio-Datei oder URL hinterlegt.");
            
            const fd = new FormData(); 
            fd.append('type', 'url'); 
            fd.append('value', val); 
            
            // Alte Metadaten behalten
            const meta = { 
                name: set.name, 
                artist: set.artists, 
                event: set.event, 
                tags: set.tags 
            };
            fd.append('metadata', JSON.stringify(meta));
            
            await fetch('/api/queue/add', { method: 'POST', body: fd }); 
            this.pollQueue(); 
            this.showToast("Set zur Warteschlange hinzugef√ºgt.", "", "info");
        },

        async renameItem() {
            const { type, target } = this.ui.contextMenu;
            if (!target || !type) return;
            this.closeContextMenu();

            if (type === 'set') {
                const nextName = prompt("Neuer Name f√ºr das Set:", target.name);
                if (!nextName || nextName === target.name) return;
                await fetch(`/api/sets/${target.id}/rename`, {
                    method: 'POST',
                    body: JSON.stringify({ name: nextName })
                });
                this.fetchSets();
                if (this.activeSet && this.activeSet.id === target.id) this.activeSet.name = nextName;
                return;
            }

            if (type === 'track') {
                const nextTitle = prompt("Neuer Titel f√ºr den Track:", target.title || target.name || '');
                if (!nextTitle || nextTitle === target.title) return;
                await fetch(`/api/tracks/${target.id}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title: nextTitle })
                });
                const track = this.tracks.find(t => t.id === target.id);
                if (track) track.title = nextTitle;
                this.likedTracks = this.likedTracks.map(t => t.id === target.id ? { ...t, title: nextTitle } : t);
            }
        },

        async deleteItem() {
            const { type, target } = this.ui.contextMenu;
            if (!target || !type) return;
            this.closeContextMenu();

            if (type === 'set') {
                if (!confirm(`Set "${target.name}" wirklich l√∂schen?`)) return;
                await fetch(`/api/sets/${target.id}`, { method: 'DELETE' });
                this.sets = this.sets.filter(s => s.id !== target.id);
                this.filteredSets = this.filteredSets.filter(s => s.id !== target.id);
                if (this.activeSet && this.activeSet.id === target.id) {
                    this.activeSet = null;
                    this.tracks = [];
                }
                this.showDashboard();
                return;
            }

            if (type === 'track') {
                if (!confirm(`Track "${target.title || target.name}" l√∂schen?`)) return;
                await fetch(`/api/tracks/${target.id}`, { method: 'DELETE' });
                this.tracks = this.tracks.filter(t => t.id !== target.id);
                this.likedTracks = this.likedTracks.filter(t => t.id !== target.id);
                this.purchasedTracks = this.purchasedTracks.filter(t => t.id !== target.id);

                if (this.activeSet && this.activeSet.track_count !== undefined && this.activeSet.track_count > 0) {
                    this.activeSet.track_count -= 1;
                }
                const idx = this.sets.findIndex(s => this.activeSet && s.id === this.activeSet.id);
                if (idx >= 0 && this.sets[idx].track_count > 0) {
                    this.sets[idx].track_count -= 1;
                    this.filteredSets = [...this.sets];
                }
            }
        },

        moveItemToFolder(folder) {
            const { target, type } = this.ui.contextMenu;
            if (!target || !type) return;
            this.ui.contextMenu.folderTarget = folder;
            this.closeContextMenu();
            target.folder = folder;
            const label = type === 'set' ? target.name : (target.title || target.name || 'Track');
            this.showToast('Verschoben', `${label} -> ${folder.name || folder}`, 'info');
        },

        showDetails(item = null, type = null) {
            const detailItem = item || this.ui.contextMenu.target;
            const detailType = type || this.ui.contextMenu.type;
            if (!detailItem || !detailType) return;
            this.closeContextMenu();
            this.ui.detailPanel = { show: true, type: detailType, item: detailItem };
        },

        closeDetailPanel() {
            this.ui.detailPanel = { show: false, type: null, item: null };
        },

        // =====================================================================
        // AUDIO PLAYER & PRELOADER
        // =====================================================================
        updateVolume(e) {
            const val = parseFloat(e.target.value);
            this.audio.volume = val;
            if(this.$refs.player) this.$refs.player.volume = val;
            if (this.audioController) this.audioController.syncVolume();
            localStorage.setItem('tracklistify_volume', val);
        },
        
        async togglePlay(track) {
            if (!track) return;
            if (this.audioController) return this.audioController.toggle(track);
        },
        
        togglePlayPauseGlobal() {
            if (!this.activeTrack && !this.ui.playingId) return;
            const current = this.tracks.find(t => t.id === this.ui.playingId) || this.activeTrack;
            if (current && this.audioController) return this.audioController.toggle(current);
            if (!this.audioController && this.$refs.player) {
                const player = this.$refs.player;
                if (player.paused) { player.play(); this.audio.paused = false; }
                else { player.pause(); this.audio.paused = true; }
            }
        },
        
        updateProgress(e) {
            if (this.audioController) return this.audioController.handleTimeUpdate(e);
            const { currentTime, duration } = e.target;
            this.audio.currentTime = currentTime;
            this.audio.duration = duration;
            this.audio.progressPercent = (currentTime / duration) * 100 || 0;
            this.audio.paused = e.target.paused;
        },
        
        seekGlobal(e) {
            if (this.audioController) this.audioController.seekFromEvent(e, e.currentTarget);
        },
        
        seek(e, track) {
            if (!track) return;
            const player = this.$refs.player;
            if (this.ui.playingId !== track.id) {
                this.togglePlay(track).then(() => {
                    if (this.audioController) this.audioController.seekFromEvent(e, e.currentTarget);
                });
                return;
            }

            if (this.audioController && player?.duration) this.audioController.seekFromEvent(e, e.currentTarget);
        },

        startProgressDrag(e) { if (this.audioController) this.audioController.startSeek(e); },
        dragProgress(e) { if (this.audioController) this.audioController.handleSeekMove(e); },
        endProgressDrag(e) { if (this.audioController) this.audioController.stopSeek(e); },
        playNextInQueue() { if (this.audioController) this.audioController.next(); },
        playPreviousInQueue() { if (this.audioController) this.audioController.previous(); },

        // --- Preloading Engine ---
        startPreloading() {
            this.preloadQueue = [];
            this.preloadQueue = this.tracks.filter(t => !t.streamUrl).map(t => t.id);
            this.triggerPreloadWorker();
        },
        
        prioritizePreload(trackId) {
            // Hover Turbo
            const track = this.tracks.find(t => t.id === trackId);
            if (!track || track.streamUrl) return;
            
            const idx = this.preloadQueue.indexOf(trackId);
            if (idx > -1) this.preloadQueue.splice(idx, 1);
            
            this.preloadQueue.unshift(trackId);
            this.triggerPreloadWorker();
        },
        
        triggerPreloadWorker() {
            while (this.activePreloads < this.maxPreloads && this.preloadQueue.length > 0) {
                this.preloadSingleTrack(this.preloadQueue.shift());
            }
        },
        
        async preloadSingleTrack(trackId) {
            this.activePreloads++;
            const track = this.tracks.find(t => t.id === trackId);
            
            if (!track || track.streamUrl) {
                this.activePreloads--;
                this.triggerPreloadWorker();
                return;
            }
            
            try {
                const res = await fetch('/api/resolve_audio', { 
                    method: 'POST', 
                    body: JSON.stringify({ query: `${track.artist} - ${track.title}` }) 
                });
                const data = await res.json();
                if (data.ok) track.streamUrl = data.url;
            } catch(e) {} 
            finally {
                this.activePreloads--;
                this.triggerPreloadWorker();
            }
        },

        // =====================================================================
        // TRACK ACTIONS & API FETCHERS
        // =====================================================================
        async fetchDashboard() { const res = await fetch('/api/dashboard'); this.dashboardStats = await res.json(); },
        async fetchSets() { const res = await fetch('/api/sets'); this.sets = await res.json(); this.filteredSets = this.sets; this.deriveFoldersFromSets(); },
        async fetchLikes() { const res = await fetch('/api/tracks/likes'); this.likedTracks = await res.json(); },
        async fetchPurchases() { const res = await fetch('/api/tracks/purchases'); this.purchasedTracks = await res.json(); },
        async fetchProducerLikes() { const res = await fetch('/api/producers/likes'); this.favoriteProducers = await res.json(); },
        async fetchRescan() { const res = await fetch('/api/tracks/rescan_candidates'); this.rescanCandidates = await res.json(); },
        deriveYoutubeArtists(query = '') {
            const filter = query ? query.toLowerCase() : null;
            const names = new Set();

            this.likedTracks.forEach(track => {
                [track.artist, track.producer_name].forEach(name => {
                    if (!name) return;
                    const trimmed = name.trim();
                    if (!trimmed) return;
                    if (filter && !trimmed.toLowerCase().includes(filter)) return;
                    names.add(trimmed);
                });
            });

            return Array.from(names);
        },
        async fetchYoutube(artists = [], query = '') {
            const artistList = artists.length ? artists : this.deriveYoutubeArtists(query);

            if (!artistList.length) {
                this.youtubeFeed = [];
                return;
            }

            const params = new URLSearchParams();
            params.set('artists', artistList.join(','));
            if (query) params.set('q', query);

            try {
                const res = await fetch(`/api/youtube/feeds?${params.toString()}`);
                const data = await res.json();
                if (res.ok && data.ok) {
                    this.youtubeFeed = data.items || [];
                } else {
                    this.youtubeFeed = [];
                    if (data.error) this.showToast('YouTube Feed', data.error, 'warning');
                }
            } catch (e) {
                this.youtubeFeed = [];
            }
        },
        async refreshEngagementFeeds(query = '') {
            await Promise.all([
                this.fetchDashboard(),
                this.fetchYoutube([], query)
            ]);
        },

        deriveFoldersFromSets() {
            const folderNames = new Set();
            this.sets.forEach(set => {
                if (set.tags) {
                    set.tags.split(',')
                        .map(t => t.trim())
                        .filter(Boolean)
                        .forEach(name => folderNames.add(name));
                }
            });
            this.folders = Array.from(folderNames).map(name => ({ id: name.toLowerCase().replace(/\s+/g, '-'), name }));
        },

        async fetchProfile() {
            try {
                const res = await fetch('/api/auth/profile');
                if (res.ok) {
                    const data = await res.json();
                    if (data.ok) this.auth.user = data.user;
                } else if (res.status === 401) {
                    this.auth.user = null;
                }
            } catch(e) {}
        },
        async submitAuth() {
            const url = this.auth.mode === 'login' ? '/api/auth/login' : '/api/auth/register';
            this.auth.error = '';
            const res = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(this.auth.form)
            });
            const data = await res.json();
            if (res.ok && data.ok) {
                this.auth.user = data.user;
                this.auth.form = { email: '', password: '', name: '' };
                this.auth.dropdownOpen = false;
                const name = data.user.name || data.user.dj_name || data.user.email;
                this.showToast('Angemeldet', name, 'info');
            } else {
                this.auth.error = data.error || 'Fehler';
            }
        },
        async logout() {
            await fetch('/api/auth/logout', { method: 'POST' });
            this.auth.user = null;
            this.auth.dropdownOpen = false;
        },

    toggle(source) {
        if (this.currentTrack === source && !this.audio.paused) {
            this.audio.pause();
            return false;
        }
        this.play(source);
        return true;
    }
}

class UIManager {
    constructor(options) {
        this.gridEl = options.gridEl;
        this.tracklistEl = options.tracklistEl;
        this.folderListEl = options.folderListEl;
        this.trashZoneEl = options.trashZoneEl;
        this.searchInput = options.searchInput;
        this.statsEls = options.statsEls;
        this.setsListEl = options.setsListEl;
        this.toastStack = options.toastStack;
        this.activeSetTitle = options.activeSetTitle;
        this.emptyTracklist = options.emptyTracklist;
        this.uploadModal = options.uploadModal;
    }

    bindSetGridHandlers({ onSelect, onDragStart, onDragEnd }) {
        if (!this.gridEl) return;
        this.gridEl.addEventListener('click', (event) => {
            const card = event.target.closest('[data-set-id]');
            if (card && onSelect) {
                onSelect(card.dataset.setId);
            }
        });
        this.gridEl.addEventListener('dragstart', (event) => {
            const card = event.target.closest('[data-set-id]');
            if (card && onDragStart) {
                onDragStart(card.dataset.setId, event);
            }
        });
        this.gridEl.addEventListener('dragend', () => {
            if (onDragEnd) onDragEnd();
        });
    }

    bindFolderHandlers({ onFolderSelect, onDrop }) {
        if (!this.folderListEl) return;
        this.folderListEl.addEventListener('click', (event) => {
            const folder = event.target.closest('[data-folder-id]');
            if (folder && onFolderSelect) {
                onFolderSelect(folder.dataset.folderId);
            }
        });
        ['dragenter', 'dragover'].forEach((type) => {
            this.folderListEl.addEventListener(type, (event) => {
                const folder = event.target.closest('[data-folder-id]');
                if (folder) {
                    event.preventDefault();
                    folder.classList.add('is-hovered');
                }
            });
            this.persistFoldersLocally();
        },

        async assignSetToFolder(set, folder) {
            if (!set || !folder) return;

            (this.folders || []).forEach(f => {
                f.sets = (f.sets || []).filter(id => id !== set.id);
            });

            folder.sets = folder.sets || [];
            if (!folder.sets.includes(set.id)) folder.sets.push(set.id);
            set.folder_id = folder.id;

            try {
                await fetch(`/api/folders/${folder.id}/sets`, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ set_id: set.id }) 
                });
            } catch (e) {}

            this.persistFoldersLocally();
        },

        syncFolderAssignments() {
            if (!this.sets || !this.sets.length) return;

            this.ensureFolderStructure();
            const setMap = new Map(this.sets.map(s => [s.id, s]));
            this.sets.forEach(set => set.folder_id = null);

            (this.folders || []).forEach(folder => {
                folder.sets = Array.from(new Set((folder.sets || []).map(item => typeof item === 'object' ? item.id : item).filter(id => setMap.has(id))));
                folder.sets.forEach(setId => {
                    const target = setMap.get(setId);
                    if (target) target.folder_id = folder.id;
                });
            });

            this.persistFoldersLocally();
            this.updateFilteredSets();
        },

        async createFolder() {
            const name = (this.folderForm.name || '').trim() || this.defaultFolderName();
            const optimisticId = `local-${Date.now()}`;
            const optimisticFolder = { id: optimisticId, name, sets: [] };
            this.folders = [optimisticFolder, ...this.folders];
            this.ensureFolderStructure();
            this.persistFoldersLocally();
            this.activeFolderId = optimisticId;
            this.updateFilteredSets();
            let created = null;

            try {
                const res = await fetch('/api/folders', { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ name }) 
                });
                if (res.ok) {
                    const data = await res.json();
                    created = data.folder || data;
                    created.sets = created.sets || [];
                    this.folders = this.folders.map(folder => folder.id === optimisticId ? created : folder);
                    this.activeFolderId = created.id;
                    this.ensureFolderStructure();
                    this.syncFolderAssignments();
                }
            } catch (e) {}

            if (created) this.ensureFolderStructure([created, ...this.folders]);
            this.syncFolderAssignments();
            this.persistFoldersLocally();
        },

        updateFoldersFromServer(folders) {
            this.ensureFolderStructure(folders);
            this.syncFolderAssignments();
            this.persistFoldersLocally();
        },

        applyFolderAssignment(folderId, setId) {
            const targetId = !Number.isNaN(Number(folderId)) ? Number(folderId) : folderId;
            this.folders = (this.folders || []).map(folder => {
                const normalizedSets = new Set((folder.sets || []).map(item => typeof item === 'object' ? item.id : item));
                normalizedSets.delete(setId);
                if (folder.id === targetId) normalizedSets.add(setId);
                return { ...folder, sets: Array.from(normalizedSets) };
            });
        });
        this.folderListEl.addEventListener('drop', (event) => {
            const folder = event.target.closest('[data-folder-id]');
            if (folder && onDrop) {
                event.preventDefault();
                onDrop(folder.dataset.folderId, event);
            }
        },

        onDragEnd() {
            this.draggingSet = null;
            this.folderHoverId = null;
            this.trashHover = false;
            this.cardHoverId = null;
        },

        setCardClasses(set) {
            return {
                'is-dragging': this.draggingSet && this.draggingSet.id === set.id,
                'is-drop-target': this.cardHoverId === set.id
            };
        },

        onCardDragEnter(set) {
            this.cardHoverId = set?.id || null;
        },

        onCardDragLeave(set) {
            if (this.cardHoverId === (set?.id || null)) this.cardHoverId = null;
        },

        onCardDragOver(event) {
            if (event && event.dataTransfer) event.dataTransfer.dropEffect = 'move';
        },

        onCardDrop(set, event) {
            event.preventDefault();
            this.cardHoverId = null;
            const target = set || this.resolveDraggedSet(event);
            if (target) this.focusOnSet(target);
            this.onDragEnd();
        },

        resolveDraggedSet(event) {
            if (this.draggingSet) return this.draggingSet;
            const dataTransfer = event?.dataTransfer;
            if (!dataTransfer) return null;

            const json = dataTransfer.getData('application/json');
            if (json) {
                try {
                    const payload = JSON.parse(json);
                    const payloadId = payload.setId ?? payload.set_id ?? payload.id;
                    const numericId = !Number.isNaN(Number(payloadId)) ? Number(payloadId) : payloadId;
                    if (payloadId) {
                        return this.sets.find(s => s.id === numericId) || { id: numericId };
                    }
                } catch (e) {}
            }

            const text = dataTransfer.getData('text/plain');
            const idFromText = parseInt(text, 10);
            if (idFromText) return this.sets.find(s => s.id === idFromText) || { id: idFromText };
            return null;
        },

        onFolderDragEnter(folder, event) {
            event.preventDefault();
            this.draggingSet = this.draggingSet || this.resolveDraggedSet(event);
            this.folderHoverId = folder.id;
        },

        onFolderDragLeave(folder) {
            if (this.folderHoverId === folder.id) this.folderHoverId = null;
        },

        onFolderDragOver(event) {
            event.preventDefault();
            if (event && event.dataTransfer) event.dataTransfer.dropEffect = 'move';
        },

        async onDropToFolder(folder, event) {
            event.preventDefault();
            const dragged = this.resolveDraggedSet(event);
            const resolvedSet = dragged ? (this.sets.find(s => s.id === dragged.id) || dragged) : null;
            this.draggingSet = null;
            this.folderHoverId = null;
            this.cardHoverId = null;
            if (!resolvedSet) return;
            await this.assignSetToFolder(resolvedSet, folder);
        },

        async renameFolderContext(folder = this.ui.contextMenu.target) {
            this.closeContextMenu();
            if (!folder) return;
            const next = prompt('Ordner umbenennen', folder.name) || folder.name;
            if (next === folder.name) return;
            folder.name = next;

            try {
                const res = await fetch(`/api/folders/${folder.id}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: next })
                });
                if (res && res.ok) {
                    const data = await res.json();
                    if (data.folders) this.updateFoldersFromServer(data.folders);
                }
            } catch (e) {}
            this.persistFoldersLocally();
        },

        onTrashDragEnter(event) {
            event.preventDefault();
            this.draggingSet = this.draggingSet || this.resolveDraggedSet(event);
            this.trashHover = true;
        },

        onTrashDragLeave() {
            this.trashHover = false;
        },

        async onDropToTrash(event) {
            event.preventDefault();
            const set = this.resolveDraggedSet(event);
            this.draggingSet = null;
            this.folderHoverId = null;
            this.trashHover = false;
            this.cardHoverId = null;
            if (!set) return;
            await this.deleteSet(set, { prompt: true });
        },

        async deleteFolderContext(folder = this.ui.contextMenu.target) {
            this.closeContextMenu();
            if (!folder) return;

            if (!confirm(`Ordner "${folder.name}" l√∂schen?`)) return;

            this.folders = (this.folders || []).filter(f => f.id !== folder.id);
            this.sets.forEach(set => {
                if (set.folder_id === folder.id) set.folder_id = null;
            });

            try {
                await fetch(`/api/folders/${folder.id}`, { method: 'DELETE' });
            } catch (e) {}

            this.persistFoldersLocally();
        },

        isProducerFavorite(producerId) {
            if (!producerId) return false;
            return this.favoriteProducers.some(p => p.id === producerId);
        },

        async toggleProducerFavorite(item) {
            const producerId = item?.producer_id || item?.id;
            if (!producerId) return;

            const currentFavorite = this.isProducerFavorite(producerId);
            const nextStatus = !currentFavorite;

            await fetch(`/api/producers/${producerId}/like`, {
                method: 'POST',
                body: JSON.stringify({ liked: nextStatus ? 1 : 0 })
            });
        });
        ['dragleave', 'drop'].forEach((type) => {
            this.trashZoneEl.addEventListener(type, () => this.trashZoneEl.classList.remove('is-hovered'));
        });
        this.trashZoneEl.addEventListener('drop', (event) => {
            event.preventDefault();
            if (onDrop) onDrop(event);
        });
    }

    renderFolders(folders, activeFolderId) {
        if (!this.folderListEl) return;
        const frag = document.createDocumentFragment();
        folders.forEach((folder) => {
            const item = document.createElement('div');
            item.className = `folder ${activeFolderId === String(folder.id) ? 'is-hovered' : ''}`;
            item.dataset.folderId = folder.id;
            item.innerHTML = `
                <div class="meta">
                    <div class="name">${folder.name}</div>
                    <div class="count">${(folder.sets?.length || 0)} sets</div>
                </div>
                <span class="pill">${(folder.sets?.length || 0)}x</span>
            `;
            frag.appendChild(item);
        });
        if (!folders.length) {
            const empty = document.createElement('div');
            empty.className = 'hint';
            empty.textContent = 'No folders yet';
            frag.appendChild(empty);
        }
        this.folderListEl.replaceChildren(frag);
    }

    renderSetGrid(sets) {
        if (!this.gridEl) return;
        const frag = document.createDocumentFragment();
        sets.forEach((set) => frag.appendChild(this.createSetCard(set)));
        if (!sets.length) {
            const empty = document.createElement('div');
            empty.className = 'set-card';
            empty.style.display = 'flex';
            empty.style.alignItems = 'center';
            empty.style.justifyContent = 'center';
            empty.textContent = 'No sets yet';
            frag.appendChild(empty);
        }
        this.gridEl.replaceChildren(frag);
    }

    renderSetList(sets) {
        if (!this.setsListEl) return;
        const frag = document.createDocumentFragment();
        sets.forEach((set) => {
            const button = document.createElement('button');
            button.className = 'w-full text-left px-4 py-3 border-b last:border-b-0';
            button.dataset.setId = set.id;
            button.innerHTML = `
                <div class="flex items-center justify-between text-[12px] font-bold gap-2">
                    <div class="flex items-center gap-2 truncate">
                        <span class="truncate">${set.name}</span>
                    </div>
                    <span class="font-mono px-2 py-0.5 pill">${set.track_count || 0}</span>
                </div>
                <div class="text-[10px] muted">${this.formatDate(set.created_at)}</div>
            `;
            frag.appendChild(button);
        });
        if (!sets.length) {
            const empty = document.createElement('div');
            empty.className = 'hint';
            empty.style.padding = '12px 16px';
            empty.textContent = 'No sets yet';
            frag.appendChild(empty);
        }
        this.setsListEl.replaceChildren(frag);
    }

    renderTracks(tracks) {
        if (!this.tracklistEl) return;
        const frag = document.createDocumentFragment();
        tracks.forEach((track, index) => {
            const row = document.createElement('div');
            row.className = 'track';
            row.dataset.trackId = track.id;
            row.innerHTML = `
                <div class="pos">
                    <button class="icon-button" data-action="play-track" data-track-id="${track.id}" style="width:32px; height:32px; border-radius:10px;">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
                    </button>
                    <span>${track.flag === 3 ? '???' : (track.position || index + 1)}</span>
                </div>
                <div class="names">
                    <div class="song">${track.title || 'Unknown Track'}</div>
                    <div class="artist">${track.artist || 'Unknown Artist'}</div>
                </div>
                <div class="names">
                    <div class="artist">Start</div>
                    <div class="song" style="font-size:13px;">${this.formatTime(track.start_time)}</div>
                </div>
                <div class="names">
                    <div class="artist">Confidence</div>
                    <div class="song" style="font-size:13px;">${this.formatConf(track.confidence)}</div>
                </div>
                <div class="controls">
                    <button class="ghost-button" data-action="purchase-track" data-track-id="${track.id}">${track.purchased ? 'Bought' : 'Buy'}</button>
                    <button class="ghost-button" data-action="like-track" data-track-id="${track.id}">${track.liked ? 'Liked' : 'Like'}</button>
                </div>
            `;
            frag.appendChild(row);
        });
        this.tracklistEl.replaceChildren(frag);
        if (this.emptyTracklist) {
            this.emptyTracklist.classList.toggle('is-hidden', tracks.length > 0);
        }
    }

            await this.fetchProducerLikes();
        },
        
        async toggleFlag(track) {
            if (!this.ensureAuthenticated()) return;

            const newFlag = track.flag === 3 ? 0 : 3;
            track.flag = newFlag;
            
            await fetch(`/api/tracks/${track.id}/flag`, {
                method: 'POST',
                body: JSON.stringify({flag: newFlag})
            }).then(res => { if (res.status === 401) this.ensureAuthenticated(); });
            this.fetchRescan();
        },

        async runRescan() {
            if (!this.ensureAuthenticated()) return;

            if(!confirm("Alle markierten Tracks neu verarbeiten?")) return;
            await fetch('/api/tracks/rescan_run', { method: 'POST' }).then(res => { if (res.status === 401) this.ensureAuthenticated(); });
            this.fetchRescan();
        },
        
        // =====================================================================
        // UTILS & HELPERS
        // =====================================================================
        onAudioEnded() { if (this.audioController) this.audioController.handleEnded(); else { this.ui.playingId = null; this.audio.progressPercent = 0; this.audio.paused = true; } },
        onAudioPaused() { this.audio.paused = true; },
        onAudioPlaying() { this.audio.paused = false; },
        onAudioError() { if (this.audioController) this.audioController.handleError(); else { this.ui.playingId = null; this.ui.loadingId = null; } },
        
        showToast(title, subtitle = '', type = 'default') {
            const id = Date.now();
            this.toasts.push({ id, title, subtitle, type });
            setTimeout(() => { this.toasts = this.toasts.filter(t => t.id !== id) }, 4000);
        },

        formatTime(s) { if (!s) return '00:00'; const m = Math.floor(s / 60); const sec = Math.floor(s % 60); return `${m}:${sec.toString().padStart(2, '0')}`; },
        formatDate(s) { if (!s) return ''; return new Date(s).toLocaleDateString('de-DE'); },
        formatConf(c) { if(c === null || c === undefined) return '-'; return Math.round(c * 100) + '%'; },
        
        getConfColor(c) { 
            if (c >= 0.8) return 'bg-green-100 text-green-800'; 
            if (c >= 0.5) return 'bg-yellow-100 text-yellow-800'; 
            return 'bg-red-100 text-red-800'; 
        },
        
        getPhaseColor(phase) { 
            if (phase === 'downloading') return 'bg-blue-500'; 
            if (phase === 'analyzing') return 'bg-orange-500'; 
            if (phase === 'importing') return 'bg-green-500'; 
            return 'bg-gray-500'; 
        },
        
        getPhaseLabel(phase) {
            if (phase === 'downloading') return 'Download';
            if (phase === 'analyzing') return 'Analyse';
            if (phase === 'importing') return 'Import';
            return 'Verarbeite...';
        },

        statHighlights() {
            return [
                { key: 'sets', label: 'SETS', value: this.dashboardStats.total_sets || 0 },
                { key: 'tracks', label: 'TRACKS', value: this.dashboardStats.total_tracks || 0 },
                { key: 'likes', label: 'LIKES', value: this.dashboardStats.total_likes || 0 },
                { key: 'discovery', label: 'DISCOVERY', value: (this.dashboardStats.discovery_rate || 0) + '%' }
            ];
        },

        hasSetThumbnail(set) {
            return Boolean(set?.thumbnail || set?.thumbnail_url);
        },

        setCardBackground(set) {
            const thumb = set?.thumbnail || set?.thumbnail_url;
            if (!thumb) return '';
            return `background-image: linear-gradient(180deg, rgba(0,0,0,0.15), rgba(0,0,0,0.55)), url('${thumb}')`;
        },

        setFolderLabel(set) {
            if (!set?.folder_id) return 'NO FOLDER';
            const match = (this.folders || []).find(f => f.id === set.folder_id);
            return match ? match.name : 'NO FOLDER';
        },
        
        cleanLogMessage(msg) {
            const parts = msg.split(' - ');
            const level = parts[0]?.toLowerCase();

            if (parts.length >= 3 && ['info', 'debug', 'warning', 'error'].includes(level)) {
                return parts.slice(2).join(' - ').trim();
    renderStats(stats = {}) {
        Object.entries(this.statsEls).forEach(([key, el]) => {
            if (!el) return;
            if (key === 'discovery_rate') {
                el.textContent = `${stats[key] ?? 0}%`;
            } else {
                el.textContent = stats[key] ?? 0;
            }
        });
    }

    updateActiveSetTitle(title) {
        if (this.activeSetTitle) {
            this.activeSetTitle.textContent = title || 'Select a set to view tracks';
        }
    }

    toggleUploadModal(visible) {
        if (!this.uploadModal) return;
        this.uploadModal.classList.toggle('is-hidden', !visible);
    }

    showToast(title, subtitle = '') {
        if (!this.toastStack) return;
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.innerHTML = `<div class="title">${title}</div><div class="subtitle">${subtitle}</div>`;
        this.toastStack.appendChild(toast);
        setTimeout(() => toast.remove(), 4000);
    }

    createSetCard(set) {
        const card = document.createElement('div');
        card.className = 'set-card';
        card.dataset.setId = set.id;
        card.draggable = true;
        const thumbStyle = set.thumbnail ? `style="background-image:url(${set.thumbnail})"` : '';
        const fallback = (set.artists || set.dj_names || set.name || 'SET').slice(0, 6).toUpperCase();
        card.innerHTML = `
            <div class="set-thumb" ${thumbStyle}>
                ${set.thumbnail ? '' : `<div class="fallback">${fallback}</div>`}
            </div>
            <div class="set-meta">
                <div class="set-pill">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 6h6l2 3h8v9H4z"/></svg>
                    <span>${set.track_count || 0} tracks</span>
                </div>
                <div class="set-title">${set.name}</div>
                <div class="set-artist">${set.artists || set.dj_names || 'Unknown Artist'}</div>
            </div>
            <div class="set-footer">
                <span>${this.formatDate(set.created_at)}</span>
                <span>${set.event || 'Ready'}</span>
            </div>
        `;
        return card;
    }

    formatDate(value) {
        if (!value) return '‚Äî';
        const date = new Date(value);
        if (Number.isNaN(date.getTime())) return '‚Äî';
        return date.toLocaleDateString();
    }

    formatTime(seconds) {
        if (!seconds && seconds !== 0) return '‚Äî';
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60).toString().padStart(2, '0');
        return `${mins}:${secs}`;
    }

    formatConf(conf) {
        if (conf === undefined || conf === null) return '‚Äî';
        return `${Math.round(conf * 100)}%`;
    }
}

class UploadManager {
    constructor(modalEl, api, ui) {
        this.modal = modalEl;
        this.api = api;
        this.ui = ui;
        this.inputs = {
            url: document.getElementById('upload-url'),
            artist: document.getElementById('upload-artist'),
            title: document.getElementById('upload-title'),
            event: document.getElementById('upload-event'),
            tags: document.getElementById('upload-tags'),
            b2b: document.getElementById('upload-b2b')
        };
    }

    bind() {
        document.querySelectorAll('[data-action="open-upload"]').forEach((btn) => btn.addEventListener('click', () => this.ui.toggleUploadModal(true)));
        document.querySelectorAll('[data-action="close-upload"]').forEach((btn) => btn.addEventListener('click', () => this.ui.toggleUploadModal(false)));
        const fetchBtn = document.querySelector('[data-action="fetch-metadata"]');
        if (fetchBtn) fetchBtn.addEventListener('click', () => this.fetchMetadata());
        const submitBtn = document.querySelector('[data-action="submit-upload"]');
        if (submitBtn) submitBtn.addEventListener('click', () => this.submit());
    }

    async fetchMetadata() {
        const url = this.inputs.url?.value?.trim();
        if (!url) return;
        try {
            const data = await this.api.resolveMetadata(url);
            if (data?.name && !this.inputs.title.value) this.inputs.title.value = data.name;
            if (data?.artist && !this.inputs.artist.value) this.inputs.artist.value = data.artist;
            if (data?.event && !this.inputs.event.value) this.inputs.event.value = data.event;
            this.ui.showToast('Metadata fetched', data?.name || '');
        } catch (e) {
            this.ui.showToast('Could not fetch metadata');
        }
    }

    async submit() {
        const url = this.inputs.url?.value?.trim();
        if (!url) {
            this.ui.showToast('Please provide a URL');
            return;
        }
        const metadata = {
            name: this.inputs.title?.value || '',
            artist: this.inputs.artist?.value || '',
            event: this.inputs.event?.value || '',
            tags: this.inputs.tags?.value || '',
            is_b2b: !!this.inputs.b2b?.checked
        };

        const formData = new FormData();
        formData.append('type', 'url');
        formData.append('value', url);
        formData.append('metadata', JSON.stringify(metadata));

        try {
            await this.api.addToQueue(formData);
            this.ui.toggleUploadModal(false);
            this.reset();
            this.ui.showToast('Import started', 'Added to queue');
        } catch (e) {
            this.ui.showToast('Failed to start import');
        }
    }

    reset() {
        Object.values(this.inputs).forEach((input) => {
            if (input?.type === 'checkbox') {
                input.checked = false;
            } else if (input) {
                input.value = '';
            }
        });
    }
}

class App {
    constructor() {
        const statsEls = {};
        document.querySelectorAll('[data-stat]').forEach((el) => {
            statsEls[el.dataset.stat] = el;
        });

        this.api = new API('/api');
        this.ui = new UIManager({
            gridEl: document.querySelector('[data-sets-grid]'),
            tracklistEl: document.getElementById('tracklist'),
            folderListEl: document.getElementById('folder-list'),
            trashZoneEl: document.getElementById('trash-zone'),
            searchInput: document.getElementById('set-search'),
            statsEls,
            setsListEl: document.getElementById('sets-list'),
            toastStack: document.getElementById('toast-stack'),
            activeSetTitle: document.getElementById('active-set-title'),
            emptyTracklist: document.getElementById('empty-tracklist'),
            uploadModal: document.getElementById('upload-modal')
        });
        this.audio = new AudioController(document.getElementById('audio-player'));
        this.uploads = new UploadManager(document.getElementById('upload-modal'), this.api, this.ui);

        this.sets = [];
        this.filteredSets = [];
        this.folders = [];
        this.activeFolderId = null;
        this.activeSetId = null;
        this.tracks = [];
        this.draggingSetId = null;

        this.onResize = debounce(() => this.refreshGrid(), 200);
        this.onSearch = debounce((value) => this.applyFilters(value), 200);
    }

    init() {
        this.bindEvents();
        this.refreshAll();
    }

    bindEvents() {
        this.ui.bindSetGridHandlers({
            onSelect: (id) => this.loadSet(id),
            onDragStart: (id, event) => this.handleDragStart(id, event),
            onDragEnd: () => this.handleDragEnd()
        });
        this.ui.bindFolderHandlers({
            onFolderSelect: (id) => this.selectFolder(id),
            onDrop: (folderId, event) => this.dropOnFolder(folderId, event)
        });
        this.ui.bindTrashHandlers((event) => this.dropOnTrash(event));

        const searchInput = this.ui.searchInput;
        if (searchInput) {
            searchInput.addEventListener('input', (event) => this.onSearch(event.target.value));
        }

        document.addEventListener('click', (event) => {
            const setButton = event.target.closest('#sets-list [data-set-id]');
            if (setButton) this.loadSet(setButton.dataset.setId);

            const trackButton = event.target.closest('[data-action="play-track"]');
            if (trackButton) this.toggleTrackPlayback(trackButton.dataset.trackId);

            const copyBtn = event.target.closest('[data-action="copy-tracklist"]');
            if (copyBtn) this.copyTracklist();

            const createFolderBtn = event.target.closest('[data-action="create-folder"]');
            if (createFolderBtn) this.createFolder();
        });

        window.addEventListener('resize', this.onResize);
        this.uploads.bind();
    }

    async refreshAll() {
        await Promise.all([this.loadSets(), this.loadDashboard(), this.loadFolders()]);
    }

    async loadSets() {
        try {
            const data = await this.api.getSets();
            this.sets = Array.isArray(data) ? data : (data?.sets || []);
            this.applyFilters(this.ui.searchInput?.value || '');
        } catch (e) {
            this.ui.showToast('Could not load sets');
        }
    }

    applyFilters(searchTerm = '') {
        const term = searchTerm.toLowerCase();
        this.filteredSets = this.sets.filter((set) => {
            const matchesSearch = !term || set.name?.toLowerCase().includes(term) || set.artists?.toLowerCase().includes(term);
            const matchesFolder = !this.activeFolderId || set.folder_id == this.activeFolderId || (set.folders && set.folders.includes(this.activeFolderId));
            return matchesSearch && matchesFolder;
        });
        this.refreshGrid();
    }

    refreshGrid() {
        this.ui.renderSetGrid(this.filteredSets);
        this.ui.renderSetList(this.filteredSets);
    }

    async loadSet(setId) {
        if (!setId) return;
        this.activeSetId = setId;
        try {
            const tracks = await this.api.getTracks(setId);
            this.tracks = Array.isArray(tracks) ? tracks : (tracks?.tracks || []);
            const set = this.sets.find((item) => String(item.id) === String(setId));
            this.ui.updateActiveSetTitle(set?.name || 'Set');
            this.ui.renderTracks(this.tracks);
        } catch (e) {
            this.ui.showToast('Could not load set');
        }
    }

    toggleTrackPlayback(trackId) {
        const track = this.tracks.find((t) => String(t.id) === String(trackId));
        if (!track || !track.preview_url) return;
        this.audio.toggle(track.preview_url);
    }

    async loadDashboard() {
        try {
            const data = await this.api.getDashboard();
            const stats = data?.stats || data || {};
            this.ui.renderStats(stats);
        } catch (e) {
            this.ui.showToast('Could not load dashboard');
        }
    }

    async loadFolders() {
        try {
            const data = await this.api.getFolders();
            this.folders = Array.isArray(data) ? data : (data?.folders || []);
            this.ui.renderFolders(this.folders, this.activeFolderId);
        } catch (e) {
            this.ui.renderFolders([], this.activeFolderId);
        }
    }

    selectFolder(folderId) {
        this.activeFolderId = this.activeFolderId === folderId ? null : folderId;
        this.ui.renderFolders(this.folders, this.activeFolderId);
        this.applyFilters(this.ui.searchInput?.value || '');
    }

    handleDragStart(setId, event) {
        this.draggingSetId = setId;
        if (event?.dataTransfer) {
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/plain', setId);
        }
    }

    handleDragEnd() {
        this.draggingSetId = null;
    }

    async dropOnFolder(folderId, event) {
        event.preventDefault();
        const setId = this.draggingSetId || event.dataTransfer?.getData('text/plain');
        if (!setId) return;
        try {
            await this.api.assignSetToFolder(folderId, setId);
            const targetSet = this.sets.find((s) => String(s.id) === String(setId));
            if (targetSet) targetSet.folder_id = folderId;
            this.ui.showToast('Set moved', 'Folder updated');
            this.applyFilters(this.ui.searchInput?.value || '');
            this.loadFolders();
        } catch (e) {
            this.ui.showToast('Could not move set');
        }
    }

    async dropOnTrash(event) {
        event.preventDefault();
        const setId = this.draggingSetId || event.dataTransfer?.getData('text/plain');
        if (!setId) return;
        if (!confirm('Delete this set?')) return;
        try {
            await this.api.deleteSet(setId);
            this.sets = this.sets.filter((s) => String(s.id) !== String(setId));
            this.applyFilters(this.ui.searchInput?.value || '');
            this.ui.showToast('Set deleted');
        } catch (e) {
            this.ui.showToast('Could not delete set');
        }
    }

    async createFolder() {
        const name = prompt('Folder name');
        if (!name) return;
        try {
            const created = await this.api.createFolder(name);
            const folder = created?.folder || created;
            if (folder) this.folders.unshift(folder);
            this.ui.renderFolders(this.folders, this.activeFolderId);
            this.ui.showToast('Folder created', folder?.name || '');
        } catch (e) {
            this.ui.showToast('Could not create folder');
        }
    }

    async copyTracklist() {
        if (!this.tracks.length) return;
        const lines = this.tracks.map((track, index) => `${index + 1}. ${track.artist || 'Unknown'} - ${track.title || 'Unknown'}`);
        try {
            await navigator.clipboard.writeText(lines.join('\n'));
            this.ui.showToast('Tracklist copied');
        } catch (e) {
            this.ui.showToast('Clipboard unavailable');
        }
    }
}

document.addEventListener('DOMContentLoaded', () => {
    const app = new App();
    app.init();
});


================================================
DATEI: services/user_store.py
================================================
import os
import uuid
from typing import List, Optional

from dotenv import load_dotenv
from pydantic import BaseModel, EmailStr, Field, ValidationError, field_validator
from werkzeug.security import check_password_hash, generate_password_hash

from config import USERS_JSON_PATH
from services.atomic_storage import AtomicJSONStorage

DEFAULT_ADMIN_EMAIL = "admin@tracklistify.com"
DEFAULT_ADMIN_PASSWORD = "123456"

# Load environment variables (.env) immediately
load_dotenv()

class User(BaseModel):
    id: str
    email: EmailStr
    hashed_password: str
    name: str | None = None
    dj_name: str | None = None
    avatar_url: str | None = None
    soundcloud_url: str | None = None
    is_admin: bool = False
    favorites: List[str] = Field(default_factory=list)

    model_config = {
        "extra": "ignore",
    }


class LoginPayload(BaseModel):
    email: EmailStr
    password: str

    @field_validator("password")
    @classmethod
    def password_not_empty(cls, value: str) -> str:
        if not value or not value.strip():
            raise ValueError("Password erforderlich")
        return value


class RegisterPayload(LoginPayload):
    name: str | None = None

    @field_validator("password")
    @classmethod
    def password_strength(cls, value: str) -> str:
        if len(value.strip()) < 6:
            raise ValueError("Passwort muss mindestens 6 Zeichen haben")
        return value


class ProfileUpdatePayload(BaseModel):
    name: str | None = None
    dj_name: str | None = None
    avatar_url: str | None = None
    soundcloud_url: str | None = None


class InvitePayload(BaseModel):
    email: EmailStr
    name: str | None = None
    is_admin: bool = False


class FavoriteTogglePayload(BaseModel):
    item_id: str

    @field_validator("item_id")
    @classmethod
    def validate_item(cls, value: str) -> str:
        value = value.strip()
        if not value:
            raise ValueError("item_id erforderlich")
        return value


class UserStore:
    def __init__(self, storage_path: str = USERS_JSON_PATH):
        self._storage = AtomicJSONStorage(storage_path)
        self._storage.ensure_file([])

    def _load_users(self) -> List[User]:
        data = self._storage.read(default=[])
        users: List[User] = []
        for raw in data:
            try:
                users.append(User.model_validate(raw))
            except ValidationError:
                continue
        return users

    def _save_users(self, users: List[User]) -> None:
        self._storage.write([user.model_dump() for user in users])

    def list_users(self) -> List[User]:
        return self._load_users()

    def _find_index_by_id(self, users: List[User], user_id: str) -> Optional[int]:
        for idx, user in enumerate(users):
            if user.id == user_id:
                return idx
        return None

    def get_by_email(self, email: str) -> Optional[User]:
        normalized = email.lower().strip()
        for user in self._load_users():
            if user.email.lower() == normalized:
                return user
        return None

    def get_by_id(self, user_id: str) -> Optional[User]:
        for user in self._load_users():
            if user.id == user_id:
                return user
        return None

    def add_user(
        self,
        email: str,
        password: str,
        name: str | None = None,
        dj_name: str | None = None,
        avatar_url: str | None = None,
        soundcloud_url: str | None = None,
        is_admin: bool = False,
    ) -> User:
        existing = self.get_by_email(email)
        if existing:
            raise ValueError("User existiert bereits")

        user = User(
            id=str(uuid.uuid4()),
            email=email.strip(),
            hashed_password=generate_password_hash(password.strip()),
            name=name,
            dj_name=dj_name,
            avatar_url=avatar_url,
            soundcloud_url=soundcloud_url,
            is_admin=is_admin,
            favorites=[],
        )
        users = self._load_users()
        users.append(user)
        self._save_users(users)
        return user

    def authenticate(self, email: str, password: str) -> Optional[User]:
        user = self.get_by_email(email)
        if user and check_password_hash(user.hashed_password, password):
            return user
        return None

    def update_user(self, user_id: str, updates: dict) -> Optional[User]:
        users = self._load_users()
        idx = self._find_index_by_id(users, user_id)
        if idx is None:
            return None

        user = users[idx]
        for key in ["name", "dj_name", "avatar_url", "soundcloud_url"]:
            if key in updates:
                setattr(user, key, updates.get(key))

        if "password" in updates and updates["password"]:
            user.hashed_password = generate_password_hash(str(updates["password"]))

        if "is_admin" in updates:
            user.is_admin = bool(updates.get("is_admin"))

        users[idx] = user
        self._save_users(users)
        return user

    def toggle_favorite(self, user_id: str, item_id: str) -> Optional[bool]:
        users = self._load_users()
        idx = self._find_index_by_id(users, user_id)
        if idx is None:
            return None

        user = users[idx]
        favorites = set(user.favorites or [])
        if item_id in favorites:
            favorites.remove(item_id)
            changed = False
        else:
            favorites.add(item_id)
            changed = True

        user.favorites = list(favorites)
        users[idx] = user
        self._save_users(users)
        return changed

    def delete_user(self, user_id: str) -> bool:
        users = self._load_users()
        idx = self._find_index_by_id(users, user_id)
        if idx is None:
            return False
        users.pop(idx)
        self._save_users(users)
        return True

    def _ensure_admin_account(self, email: str, password: str) -> Optional[User]:
        existing = self.get_by_email(email)

        if existing:
            requires_save = False

            if password and not check_password_hash(existing.hashed_password, password):
                existing.hashed_password = generate_password_hash(password.strip())
                requires_save = True

            if not existing.is_admin:
                existing.is_admin = True
                requires_save = True

            if requires_save:
                users = self._load_users()
                idx = self._find_index_by_id(users, existing.id)
                if idx is not None:
                    users[idx] = existing
                    self._save_users(users)
            return existing

        try:
            return self.add_user(email, password, name="Admin", is_admin=True)
        except ValueError:
            return self.get_by_email(email)

    def ensure_default_admin(self) -> User:
        # Lade Credentials aus .env oder nutze Fallback (nur lokal sicher)
        raw_email = os.getenv("ADMIN_EMAIL")
        raw_password = os.getenv("ADMIN_PASSWORD")

        class _AdminEmailModel(BaseModel):
            email: EmailStr

        try:
            env_email = _AdminEmailModel(email=raw_email).email if raw_email else None
        except ValidationError:
            env_email = None

        env_password = raw_password.strip() if raw_password and raw_password.strip() else None

        admin_targets = []
        if env_email:
            admin_targets.append((env_email, env_password or DEFAULT_ADMIN_PASSWORD))
        admin_targets.append((DEFAULT_ADMIN_EMAIL, DEFAULT_ADMIN_PASSWORD))

        ensured_admin: Optional[User] = None
        seen = set()

        for email, password in admin_targets:
            if not email or email in seen:
                continue
            seen.add(email)
            candidate = self._ensure_admin_account(email, password)
            if ensured_admin is None and candidate is not None:
                ensured_admin = candidate

        # Fallback: Wenn nichts angelegt werden konnte, versuche den Default
        if ensured_admin:
            return ensured_admin
        return self._ensure_admin_account(DEFAULT_ADMIN_EMAIL, DEFAULT_ADMIN_PASSWORD)


================================================
DATEI: backend/models.py
================================================
from typing import Any, Dict, List, Literal, Optional
from pydantic import BaseModel, Field, HttpUrl


class RegisterRequest(BaseModel):
    username: str = Field(..., min_length=1)
    password: str = Field(..., min_length=1)

    model_config = {"extra": "forbid", "str_strip_whitespace": True}


class LoginRequest(RegisterRequest):
    pass


class ProfileUpdateRequest(BaseModel):
    display_name: Optional[str] = Field(default=None, min_length=1)
    bio: Optional[str] = None

    model_config = {"extra": "forbid", "str_strip_whitespace": True}


class SetRenameRequest(BaseModel):
    name: str = Field(..., min_length=1)

    model_config = {"extra": "forbid", "str_strip_whitespace": True}


class SetMetadataRequest(BaseModel):
    artists: Optional[str | List[str]] = None
    event: Optional[str] = None
    is_b2b: Optional[bool] = None
    tags: Optional[str | List[str]] = None

    model_config = {"extra": "allow", "str_strip_whitespace": True}


class ResolveMetadataRequest(BaseModel):
    url: HttpUrl | str = Field(..., min_length=1)

    model_config = {"extra": "forbid", "str_strip_whitespace": True}


class ResolveAudioRequest(BaseModel):
    query: str = Field(..., min_length=1)

    model_config = {"extra": "forbid", "str_strip_whitespace": True}


class QueueSubmission(BaseModel):
    type: Literal["url", "file"]
    value: Optional[str] = None
    metadata: Dict[str, Any] = Field(default_factory=dict)

    model_config = {"extra": "forbid", "str_strip_whitespace": True}


class TrackFlagRequest(BaseModel):
    flag: int = Field(default=0, ge=0)

    model_config = {"extra": "forbid"}


class ToggleFavoriteRequest(BaseModel):
    liked: bool

    model_config = {"extra": "forbid"}


class PurchaseToggleRequest(BaseModel):
    purchased: bool

    model_config = {"extra": "forbid"}


class FolderCreateRequest(BaseModel):
    name: str = Field(..., min_length=1)

    model_config = {"extra": "forbid", "str_strip_whitespace": True}


class FolderAssignRequest(BaseModel):
    set_id: int

    model_config = {"extra": "forbid"}


